<!doctype html>
<html lang="ja">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Â∞èÂ≠¶Ê†°„Åã„Çì„Åò„Éû„Çπ„Çø„Éº Áµ±Âêà„Éù„Éº„Çø„É´</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>

  <style>
        /* =========================================
           Âü∫Êú¨Ë®≠ÂÆö„Éª„Éù„Éº„Çø„É´ÁîªÈù¢„Çπ„Çø„Ç§„É´
           ========================================= */
        body { box-sizing: border-box; }

        :root {
            --bg-color: #F4F7F6;
            --g1-color: #FF8A65; --g2-color: #FFD54F; --g3-color: #4FC3F7;
            --g4-color: #81C784; --g5-color: #BA68C8; --g6-color: #7986CB;
        }

        body {
            font-family: 'Mochiy Pop One', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; color: #37474F;
            min-height: 100vh; overflow-y: auto; display: flex; flex-direction: column;
        }

        /* --- „Åì„Åì„Åã„ÇâËøΩÂä†ÔºöÁµåÈ®ìÂÄ§„Éê„Éº --- */
        #xp-bar-container {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 200; 
            height: 110px; flex-shrink: 0; border-bottom: 3px solid #4FC3F7;
        }
        .xp-info { display: flex; align-items: center; gap: 20px; flex-grow: 1; position: relative; }
        .char-wrapper { position: relative; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin-left: 10px; }
        .char-icon { font-size: 4.2rem; cursor: pointer; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2)); z-index: 2; }
        .aura-bg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; z-index: 1; pointer-events: none; }
        
        .aura-lv1 { width: 90px; height: 90px; box-shadow: 0 0 20px rgba(33, 150, 243, 0.6); border: 2px solid rgba(33, 150, 243, 0.3); animation: pulse-blue 2s infinite; }
        .aura-lv2 { width: 100px; height: 100px; background: conic-gradient(from 0deg, transparent, #FFD700, transparent); animation: spin-aura 3s linear infinite; filter: blur(5px); opacity: 0.7; }
        .aura-lv3 { width: 110px; height: 110px; background: conic-gradient(#ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); animation: spin-aura 1.5s linear infinite; filter: blur(8px); opacity: 0.8; box-shadow: 0 0 30px rgba(255, 255, 255, 0.8); }

        @keyframes pulse-blue { 0% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.9); } 50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.1); } 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.9); } }
        @keyframes spin-aura { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        .xp-stats { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; margin-left: 15px; }
        .xp-header { display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap;}
        .xp-text { font-size: 1.1rem; color: #222; font-weight: 800; }
        .progress-track { height: 18px; background: #ddd; border-radius: 9px; margin: 5px 15px 0 0; overflow: hidden; position: relative; width: 95%; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4FC3F7, #29B6F6); width: 0%; transition: width 1s; border-radius: 8px; }
        .xp-small { font-size: 0.85rem; color: #666; font-weight: 600; text-align: right; margin-right: 15px;}
        /* --- „Åì„Åì„Åæ„ÅßËøΩÂä†ÔºöÁµåÈ®ìÂÄ§„Éê„Éº --- */

        /* „Éò„ÉÉ„ÉÄ„Éº & Ê§úÁ¥¢ */
        header {
            background: rgba(255, 255, 255, 0.95); padding: 10px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0;
        }
        .logo { font-size: 1.3rem; display: flex; align-items: center; gap: 8px; color: #2c3e50; font-weight: 700; }
        .search-container { position: relative; width: 100%; max-width: 400px; margin: 0 15px; }
        #search-input { width: 100%; padding: 8px 15px; border-radius: 20px; border: 2px solid #ddd; background: #f5f5f5; font-family: inherit; }
        #search-results {
            position: absolute; top: 110%; left: 0; width: 100%; background: white; border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 50vh; overflow-y: auto; display: none; padding: 10px; z-index: 200;
        }
        .result-card { display: flex; align-items: center; justify-content: space-between; padding: 10px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; background: #f8f8f8; }
        .result-card:hover { background-color: #e8f4ff; }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        #home-screen { flex-grow: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; align-items: center; }
        .hero-text { text-align: center; margin: 15px 0 25px; }
        .hero-title { font-size: 1.7rem; margin-bottom: 8px; color: #1a1a1a; font-weight: 800; }
        
        .grade-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px; width: 100%; max-width: 900px; padding-bottom: 25px;
        }

        /* --- Â≠¶Âπ¥„Ç´„Éº„ÉâÔºà‰øÆÊ≠£Ôºö„Ç≤„Éº„Ç∏ËøΩÂä†ÁâàÔºâ --- */
        .grade-card {
            background: white; border-radius: 20px; padding: 15px;
            text-align: center; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            transition: transform 0.2s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            height: 180px; /* È´ò„Åï„ÇíÁ¢∫‰øù */
            border-bottom: 5px solid #ddd;
        }
        .grade-card:hover { transform: translateY(-5px); }
        .card-title { font-size: 1.1rem; font-weight: 800; color: #333; margin-bottom: 5px; z-index: 2; }
        .card-icon { font-size: 3rem; margin: 5px 0; z-index: 2; }
        
        /* „Ç≤„Éº„Ç∏ÈÉ®ÂàÜ */
        .grade-progress-box { width: 100%; z-index: 2; margin-top: auto; }
        .g-bar-track { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin-bottom: 4px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .g-bar-fill { height: 100%; width: 0%; transition: width 1s; border-radius: 6px; }
        .g-text { font-size: 0.8rem; font-weight: 700; color: #888; text-align: right; }

        .decoration-circle { position: absolute; width: 100px; height: 100px; border-radius: 50%; opacity: 0.1; z-index: 1; top: -30px; right: -30px; }

        /* „Éï„ÉÉ„Çø„Éº„Éª„Åù„ÅÆ‰ªñ */
        .footer-note { margin-top: 30px; font-size: 0.8rem; color: #666; text-align: center; background: #eee; padding: 10px; border-radius: 10px; width: 100%; max-width: 600px; }
        
        #change-course-btn {
            position: fixed; bottom: 20px; right: 20px;
            background: white; border: 2px solid #4FC3F7; border-radius: 30px;
            padding: 10px 20px; font-family: inherit; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 300;
        }

        #reset-btn { margin-top: 20px; background: none; border: 1px solid #ccc; padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; color: #666; cursor: pointer; }

        /* „Ç®„Éï„Çß„ÇØ„Éà */
        .xp-gain-effect { position: fixed; pointer-events: none; font-weight: 800; color: #29B6F6; font-size: 1.5rem; animation: xp-gain 1.2s forwards; z-index: 999; }
        @keyframes xp-gain { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        #levelup-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #FFD54F 0%, #FFCA28 100%);
            padding: 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 1000; 
            transition: transform 0.4s; border: 4px solid #fff;
        }
        #levelup-popup.show { transform: translate(-50%, -50%) scale(1); }

        #course-modal, #reset-confirm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1100;
        }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        .course-option { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; border: 2px solid transparent; background: #f9f9f9; }
        .course-option.active { border-color: #4FC3F7; background: #E1F5FE; }
        
        /* „Ç¢„Éó„É™ÁîªÈù¢„Çπ„Çø„Ç§„É´ */
        body.app-mode { background-color: #FFF3E0 !important; overflow-x: hidden; }
        #app-view { display: none; width: 100%; min-height: 100vh; }
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .screen.active { display: flex; }

        #title-screen-app { background: linear-gradient(135deg, #FFD54F, #FFB74D); }
        .game-title { font-size: 2.5rem; color: #FFF; text-shadow: 2px 2px 0 #E65100; text-align: center; margin-bottom: 30px; }
        .mode-btn { width: 260px; font-size: 1.3rem; padding: 12px 0; border-radius: 50px; border: none; cursor: pointer; margin: 10px 0; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); font-family: inherit; }
        .btn-practice { background: #66BB6A; } .btn-test { background: #EF5350; } .btn-exit { background: #78909C; font-size: 1rem; width: 150px; margin-top: 20px; }

        #list-screen { justify-content: flex-start; padding-top: 20px; background: #FFF3E0; }
        .header-info { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; width: 95%; max-width: 600px; text-align: center; }
        .kanji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; width: 100%; max-width: 800px; padding-bottom: 50px; }
        .kanji-card { background: white; aspect-ratio: 1; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; cursor: pointer; position: relative; border: 2px solid #FFE0B2; }
        .mark { position: absolute; top: -5px; right: -5px; font-size: 1rem; display: none; }
        .cleared-practice .star-mark { display: block; } .cleared-test .crown-mark { display: block; }
        .cleared-practice { background: #F1F8E9; border-color: #8BC34A; } .cleared-test { background: #FFEBEE; border-color: #EF5350; }

        #practice-screen { background: #E0F7FA; position: relative; }
        #practice-screen.test-bg { background: #FFEBEE; }
        .canvas-container { background: white; padding: 10px; border-radius: 15px; box-shadow: 0 6px 0 #B0BEC5; margin-bottom: 20px; }
        #character-target-div { width: 300px; height: 300px; }
        #result-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20; }
        #result-overlay.active { display: flex; }
        .result-btn { width: 220px; padding: 12px; margin: 8px 0; border: none; border-radius: 40px; font-size: 1.2rem; color: white; box-shadow: 0 4px 0 rgba(0,0,0,0.2); cursor: pointer; font-family: inherit; }
        .btn-next { background: #4CAF50; } .btn-retry { background: #FF9800; } .btn-home { background: #607D8B; }

        @media (max-width: 480px) { #xp-bar-container { height: 100px; } .char-icon { font-size: 3.5rem; } }
    </style>
 </head>
 <body>
  
  <div id="portal-view">
      <div id="xp-bar-container">
       <div class="xp-info">
        <div class="char-wrapper">
            <div id="aura-effect" class="aura-bg"></div>
            <div class="char-icon" id="current-char" onclick="openCourseModal()">ü•ö</div>
        </div>
        <div class="xp-stats">
         <div class="xp-header">
          <div class="xp-text">Lv.<span id="current-lvl">0</span></div>
         </div>
         <div class="progress-track">
          <div class="progress-fill" id="xp-fill"></div>
         </div>
         <div class="xp-small">„ÅÇ„Å®<span id="next-xp">5</span>ÂÄã„Åß„É¨„Éô„É´„Ç¢„ÉÉ„Éó</div>
        </div>
       </div>
      </div>
      
      <header>
       <div class="logo">üè´ Êº¢Â≠ó„Éû„Çπ„Çø„Éº</div>
       <div class="search-container">
        <input type="text" id="search-input" placeholder="„Åã„Çì„Åò„Éª„Çà„Åø" autocomplete="off">
        <div id="search-results"></div>
       </div>
      </header>
      
      <div id="home-screen">
       <div class="hero-text">
        <div class="hero-title">„Å©„ÅÆÂ≠¶Âπ¥„Å´ „Å°„Çá„ÅÜ„Åõ„Çì „Åô„ÇãÔºü</div>
       </div>
       
       <div class="grade-grid">
        <div class="grade-card" onclick="launchApp(1)" style="border-color: var(--g1-color);">
         <div class="decoration-circle" style="background: var(--g1-color);"></div>
         <div class="card-title">1„Å≠„Çì„Åõ„ÅÑ</div>
         <div class="card-icon">üê£</div>
         <div class="grade-progress-box">
             <div class="g-bar-track"><div id="g-bar-1" class="g-bar-fill" style="background:var(--g1-color)"></div></div>
             <div id="g-text-1" class="g-text">0 / 80 (0%)</div>
         </div>
        </div>
        
        <div class="grade-card" onclick="launchApp(2)" style="border-color: var(--g2-color);">
         <div class="decoration-circle" style="background: var(--g2-color);"></div>
         <div class="card-title">2„Å≠„Çì„Åõ„ÅÑ</div>
         <div class="card-icon">üêπ</div>
         <div class="grade-progress-box">
             <div class="g-bar-track"><div id="g-bar-2" class="g-bar-fill" style="background:var(--g2-color)"></div></div>
             <div id="g-text-2" class="g-text">0 / 160 (0%)</div>
         </div>
        </div>

        <div class="grade-card" onclick="launchApp(3)" style="border-color: var(--g3-color);">
         <div class="decoration-circle" style="background: var(--g3-color);"></div>
         <div class="card-title">3„Å≠„Çì„Åõ„ÅÑ</div>
         <div class="card-icon">üê¨</div>
         <div class="grade-progress-box">
             <div class="g-bar-track"><div id="g-bar-3" class="g-bar-fill" style="background:var(--g3-color)"></div></div>
             <div id="g-text-3" class="g-text">0 / 200 (0%)</div>
         </div>
        </div>

        <div class="grade-card" onclick="launchApp(4)" style="border-color: var(--g4-color);">
         <div class="decoration-circle" style="background: var(--g4-color);"></div>
         <div class="card-title">4„Å≠„Çì„Åõ„ÅÑ</div>
         <div class="card-icon">ü¶Å</div>
         <div class="grade-progress-box">
             <div class="g-bar-track"><div id="g-bar-4" class="g-bar-fill" style="background:var(--g4-color)"></div></div>
             <div id="g-text-4" class="g-text">0 / 200 (0%)</div>
         </div>
        </div>

        <div class="grade-card" onclick="launchApp(5)" style="border-color: var(--g5-color);">
         <div class="decoration-circle" style="background: var(--g5-color);"></div>
         <div class="card-title">5„Å≠„Çì„Åõ„ÅÑ</div>
         <div class="card-icon">üöÄ</div>
         <div class="grade-progress-box">
             <div class="g-bar-track"><div id="g-bar-5" class="g-bar-fill" style="background:var(--g5-color)"></div></div>
             <div id="g-text-5" class="g-text">0 / 185 (0%)</div>
         </div>
        </div>

        <div class="grade-card" onclick="launchApp(6)" style="border-color: var(--g6-color);">
         <div class="decoration-circle" style="background: var(--g6-color);"></div>
         <div class="card-title">6„Å≠„Çì„Åõ„ÅÑ</div>
         <div class="card-icon">üëë</div>
         <div class="grade-progress-box">
             <div class="g-bar-track"><div id="g-bar-6" class="g-bar-fill" style="background:var(--g6-color)"></div></div>
             <div id="g-text-6" class="g-text">0 / 181 (0%)</div>
         </div>
        </div>
       </div>
       
       <div class="footer-note">
        ‚Äª„Åì„ÅÆ„Ç¢„Éó„É™„ÅØ„Éñ„É©„Ç¶„Ç∂„Å´„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åô„ÄÇÂ±•Ê≠¥„ÇíÊ∂à„Åô„Å®„Éá„Éº„Çø„ÇÇÊ∂à„Åà„Åæ„Åô„ÄÇ
       </div>
       <button id="reset-btn" onclick="showResetConfirm()">ÂÖ®„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà</button>
      </div>
      
      <button id="change-course-btn" onclick="openCourseModal()">„Ç≥„Éº„Çπ„Çí„Åã„Åà„Çã</button>
      
      <div id="levelup-popup">
       <div style="font-size:3rem;" id="levelup-emoji">‚ú®</div>
       <div style="font-size:1.5rem; color:#fff; font-weight:bold; margin:10px 0;">„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ</div>
       <div style="color:white;" id="levelup-char"></div>
      </div>

      <div id="course-modal" onclick="if(event.target.id==='course-modal') this.style.display='none'">
       <div class="modal-content">
        <h3 style="margin-bottom:15px;">„Ç≥„Éº„Çπ„Çí„Åà„Çâ„Çì„Åß„Å≠</h3>
        <div id="course-list"></div>
        <button onclick="document.getElementById('course-modal').style.display='none'" style="margin-top:10px; padding:5px 20px;">„Å®„Åò„Çã</button>
       </div>
      </div>

      <div id="reset-confirm-overlay">
       <div class="modal-content">
        <h3 style="color:red;">„Åª„Çì„Å®„ÅÜ„Å´ „Åë„Åó„Åæ„Åô„ÅãÔºü</h3>
        <p>„Åô„Åπ„Å¶„ÅÆË®òÈå≤„ÅåÊ∂à„Åà„Åæ„Åô„ÄÇ</p>
        <button onclick="document.getElementById('reset-confirm-overlay').style.display='none'" style="padding:10px 20px; margin-right:10px;">„Ç≠„É£„É≥„Çª„É´</button>
        <button onclick="confirmReset()" style="background:#FF6B6B; color:white; border:none; padding:10px 20px; border-radius:5px;">„Éá„Éº„Çø„Çí„Åë„Åô</button>
       </div>
      </div>
  </div>

  <div id="app-view">
      <div id="title-screen-app" class="screen active">
       <div class="game-title">„Åã„Çì„Åò„Éû„Çπ„Çø„Éº</div>
       <button class="mode-btn btn-practice" onclick="selectMode('practice')">„Çå„Çì„Åó„ÇÖ„ÅÜ</button> 
       <button class="mode-btn btn-test" onclick="selectMode('test')">„ÉÜ„Çπ„Éà</button>
       <button class="mode-btn btn-exit" onclick="exitApp()">„Éù„Éº„Çø„É´„Å∏„ÇÇ„Å©„Çã</button>
      </div>
      
      <div id="list-screen" class="screen">
       <div class="header-info">
        <div id="mode-display" style="font-weight:bold; margin-bottom:5px;"></div>
        <div>„ÇØ„É™„Ç¢Êï∞Ôºö<span id="star-counter">0</span> / <span id="max-count">80</span></div>
        <input type="text" id="app-search-box" placeholder="„Åë„Çì„Åï„Åè" oninput="filterAppList()" style="width:100%; padding:5px; margin-top:10px;">
        <button onclick="showAppScreen('title-screen-app')" style="margin-top:5px; padding:5px 10px;">„Çø„Ç§„Éà„É´„Å∏</button>
       </div>
       <div class="kanji-grid" id="kanji-grid"></div>
      </div>
      
      <div id="practice-screen" class="screen">
       <div style="width:100%; max-width:500px; display:flex; justify-content:space-between; margin-bottom:20px;">
        <button onclick="showAppScreen('list-screen')" style="padding:5px 15px;">„ÇÇ„Å©„Çã</button>
        <div id="current-reading" style="font-size:1.5rem; font-weight:bold;">„Çà„Åø</div>
        <div style="width:60px;"></div>
       </div>
       <div class="canvas-container">
        <div id="character-target-div"></div>
       </div>
       <div id="message-area" style="height:30px; font-weight:bold; text-align:center;">„Å™„Åû„Å£„Å¶„Åø„Çà„ÅÜÔºÅ</div>
       <div id="result-overlay">
        <div class="result-title" id="result-title-text" style="font-size:2rem; margin-bottom:20px; font-weight:bold;">„Åß„Åç„ÅüÔºÅ</div>
        <button class="result-btn btn-next" onclick="goNext()">„Å§„Åé„Å∏</button> 
        <button class="result-btn btn-retry" onclick="retry()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button> 
        <button class="result-btn btn-home" onclick="showAppScreen('list-screen')">„Éõ„Éº„É†</button>
       </div>
       <button onclick="retry()" style="background:#ddd; margin-top:10px; border:none; padding:5px 15px; border-radius:15px; z-index:10;">Êõ∏„ÅçÁõ¥„Åô</button>
      </div>
  </div>

  <script>
        // =========================================
        // 1. „Éá„Éº„ÇøÂÆöÁæ© & Áµ±ÂêàÁÆ°ÁêÜ
        // =========================================
        const STARS_PER_LEVEL = 5;
        const CROWNS_PER_AURA = 10;

        const COURSES = {
            A: { name: "ÂÜíÈô∫„Ç≥„Éº„Çπ", chars: ["ü•ö", "üê£", "üó°Ô∏è", "üõ°Ô∏è", "üê¥", "üè∞", "üßö", "üêâ", "‚öîÔ∏è", "üëë", "üåü"] },
            B: { name: "Ëá™ÁÑ∂„Ç≥„Éº„Çπ", chars: ["üå±", "üíß", "üåø", "üçÄ", "üçÑ", "üå∑", "üåª", "üå≥", "üçé", "ü•ß", "üåà"] },
            C: { name: "‰πóÁâ©„Ç≥„Éº„Çπ", chars: ["üö∂", "üõ¥", "üö≤", "üõµ", "üöó", "üöå", "üöÖ", "üö¢", "‚úàÔ∏è", "üöÄ", "üõ∏"] },
            D: { name: "„Ç¢„Ç§„Éâ„É´",   chars: ["üéµ", "ü©∞", "üéÄ", "üíÑ", "üëó", "üé§", "üé∏", "üéπ", "üíÉ", "üì∏", "üë∏"] },
            E: { name: "ÂíåÈ¢®„ÉªÂøçËÄÖ", chars: ["üêµ", "üçô", "ü•ã", "üìú", "üó°Ô∏è", "ü•∑", "üèØ", "üë∫", "È¨º", "üéå", "üå∏"] }
        };

        const PORTAL_KEY = 'kanjiMaster_portal_v1';
        
        // ÂÖ®Êº¢Â≠ó„Éá„Éº„Çø„ÇíÁ¢∫ÂÆü„Å´Âê´„ÇÅ„ÇãÔºàÁúÅÁï•„Å™„ÅóÔºâ
        const rawData = `
        1|‰∏Ä:„ÅÑ„Å°|Âè≥:„Åø„Åé|Èõ®:„ÅÇ„ÇÅ|ÂÜÜ:„Åà„Çì|Áéã:„Åä„ÅÜ|Èü≥:„Åä„Å®|‰∏ã:„Åó„Åü|ÁÅ´:„Å≤|Ëä±:„ÅØ„Å™|Ë≤ù:„Åã„ÅÑ|Â≠¶:„Åå„Åè|Ê∞ó:„Åç|‰πù:„Åç„ÇÖ„ÅÜ|‰ºë:„ÇÑ„Åô|Áéâ:„Åü„Åæ|Èáë:„Åã„Å≠|Á©∫:„Åù„Çâ|Êúà:„Å§„Åç|Áä¨:„ÅÑ„Å¨|Ë¶ã:„Åø|‰∫î:„Åî|Âè£:„Åè„Å°|Ê†°:„Åì„ÅÜ|Â∑¶:„Å≤„Å†„Çä|‰∏â:„Åï„Çì|Â±±:„ÇÑ„Åæ|Â≠ê:„Åì|Âõõ:„Çà„Çì|Á≥∏:„ÅÑ„Å®|Â≠ó:„Åò|ËÄ≥:„Åø„Åø|‰∏É:„Å™„Å™|Ëªä:„Åè„Çã„Åæ|Êâã:„Å¶|ÂçÅ:„Åò„ÇÖ„ÅÜ|Âá∫:„Åß|Â•≥:„Åä„Çì„Å™|Â∞è:„Å°„ÅÑ|‰∏ä:„ÅÜ„Åà|Ê£Æ:„ÇÇ„Çä|‰∫∫:„Å≤„Å®|Ê∞¥:„Åø„Åö|Ê≠£:„Åü„Å†|Áîü:„ÅÑ|Èùí:„ÅÇ„Åä|Â§ï:„ÇÜ„ÅÜ|Áü≥:„ÅÑ„Åó|Ëµ§:„ÅÇ„Åã|ÂçÉ:„Åõ„Çì|Â∑ù:„Åã„Çè|ÂÖà:„Åï„Åç|Êó©:„ÅØ„ÇÑ|Ëçâ:„Åè„Åï|Ë∂≥:„ÅÇ„Åó|Êùë:„ÇÄ„Çâ|Â§ß:„Åä„Åä|Áî∑:„Åä„Å®„Åì|Á´π:„Åü„Åë|‰∏≠:„Å™„Åã|Ëô´:„ÇÄ„Åó|Áî∫:„Åæ„Å°|Â§©:„Å¶„Çì|Áî∞:„Åü|Âúü:„Å§„Å°|‰∫å:„Å´|Êó•:„Å≤|ÂÖ•:„ÅØ„ÅÑ|Âπ¥:„Å®„Åó|ÁôΩ:„Åó„Çç|ÂÖ´:„ÅØ„Å°|Áôæ:„Å≤„ÇÉ„Åè|Êñá:„Å∂„Çì|Êú®:„Åç|Êú¨:„Åª„Çì|Âêç:„Å™|ÁõÆ:„ÇÅ|Á´ã:„Åü|Âäõ:„Å°„Åã„Çâ|Êûó:„ÅØ„ÇÑ„Åó|ÂÖ≠:„Çç„Åè
        2|Âºï:„Å≤|ÁæΩ:„ÅØ„Å≠|Èõ≤:„Åè„ÇÇ|Âúí:„Åà„Çì|ÈÅ†:„Å®„Åä|‰Ωï:„Å™„Å´|Áßë:„Åã|Â§è:„Å™„Å§|ÂÆ∂:„ÅÑ„Åà|Ê≠å:„ÅÜ„Åü|Áîª:„Åå|Âõû:„Åæ„Çè|‰ºö:„ÅÇ|Êµ∑:„ÅÜ„Åø|Áµµ:„Åà|Â§ñ:„Åù„Å®|Ëßí:„Åã„Å©|Ê•Ω:„Åü„ÅÆ|Ê¥ª:„Åã„Å§|Èñì:„ÅÇ„ÅÑ„Å†|‰∏∏:„Åæ„Çã|Â≤©:„ÅÑ„Çè|È°î:„Åã„Åä|Ê±Ω:„Åç|Ë®ò:„Åç|Â∏∞:„Åã„Åà|Âºì:„ÇÜ„Åø|Áâõ:„ÅÜ„Åó|È≠ö:„Åï„Åã„Å™|‰∫¨:„Åç„Çá„ÅÜ|Âº∑:„Å§„Çà|Êïô:„Åä„Åó|Ëøë:„Å°„Åã|ÂÖÑ:„ÅÇ„Å´|ÂΩ¢:„Åã„Åü„Å°|Ë®à:„Åë„ÅÑ|ÂÖÉ:„ÇÇ„Å®|Ë®Ä:„ÅÑ|Âéü:„ÅØ„Çâ|Êà∏:„Å®|Âè§:„Åµ„Çã|Âçà:„Åî|Âæå:„ÅÇ„Å®|Ë™û:„Åî|Â∑•:„Åì„ÅÜ|ÂÖ¨:„Åì„ÅÜ|Â∫É:„Å≤„Çç|‰∫§:„Åæ„Åò|ÂÖâ:„Å≤„Åã„Çä|ËÄÉ:„Åã„Çì„Åå|Ë°å:„ÅÑ|È´ò:„Åü„Åã|ÈªÑ:„Åç|Âêà:„ÅÇ|Ë∞∑:„Åü„Å´|ÂõΩ:„Åè„Å´|Èªí:„Åè„Çç|‰ªä:„ÅÑ„Åæ|Êâç:„Åï„ÅÑ|Á¥∞:„Åª„Åù|‰Ωú:„Å§„Åè|ÁÆó:„Åï„Çì|Ê≠¢:„Å®|Â∏Ç:„Åó|Áü¢:„ÇÑ|Âßâ:„ÅÇ„Å≠|ÊÄù:„Åä„ÇÇ|Á¥ô:„Åã„Åø|ÂØ∫:„Å¶„Çâ|Ëá™:„Åò|ÊôÇ:„Å®„Åç|ÂÆ§:„Åó„Å§|Á§æ:„Åó„ÇÉ|Âº±:„Çà„Çè|È¶ñ:„Åè„Å≥|Áßã:„ÅÇ„Åç|ÈÄ±:„Åó„ÇÖ„ÅÜ|Êò•:„ÅØ„Çã|Êõ∏:„Åã|Â∞ë:„Åô„Åì|Â†¥:„Å∞|Ëâ≤:„ÅÑ„Çç|È£ü:„Åü|ÂøÉ:„Åì„Åì„Çç|Êñ∞:„ÅÇ„Åü„Çâ|Ë¶™:„Åä„ÇÑ|Âõ≥:„Åö|Êï∞:„Åã„Åö|Ë•ø:„Å´„Åó|Â£∞:„Åì„Åà|Êòü:„Åª„Åó|Êô¥:„ÅØ|Âàá:„Åç|Èõ™:„ÇÜ„Åç|Ëàπ:„Åµ„Å≠|Á∑ö:„Åõ„Çì|Ââç:„Åæ„Åà|ÁµÑ:„Åè„Åø|Ëµ∞:„ÅØ„Åó|Â§ö:„Åä„Åä|Â§™:„Åµ„Å®|‰Ωì:„Åã„Çâ„Å†|Âè∞:„Å†„ÅÑ|Âú∞:„Å°|Ê±†:„ÅÑ„Åë|Áü•:„Åó|Ëå∂:„Å°„ÇÉ|Êòº:„Å≤„Çã|Èï∑:„Å™„Åå|È≥•:„Å®„Çä|Êúù:„ÅÇ„Åï|Áõ¥:„Å™„Åä|ÈÄö:„Å®„Åä|Âºü:„Åä„Å®„ÅÜ„Å®|Â∫ó:„Åø„Åõ|ÁÇπ:„Å¶„Çì|Èõª:„Åß„Çì|ÂàÄ:„Åã„Åü„Å™|ÂÜ¨:„Åµ„ÇÜ|ÂΩì:„ÅÇ|Êù±:„Å≤„Åå„Åó|Á≠î:„Åì„Åü|È†≠:„ÅÇ„Åü„Åæ|Âêå:„Åä„Å™|ÈÅì:„Åø„Å°|Ë™≠:„Çà|ÂÜÖ:„ÅÜ„Å°|Âçó:„Åø„Å™„Åø|ËÇâ:„Å´„Åè|È¶¨:„ÅÜ„Åæ|Â£≤:„ÅÜ|Ë≤∑:„Åã|È∫¶:„ÇÄ„Åé|Âçä:„ÅØ„Çì|Áï™:„Å∞„Çì|Áà∂:„Å°„Å°|È¢®:„Åã„Åú|ÂàÜ:„Å∂„Çì|ËÅû:„Åç|Á±≥:„Åì„ÇÅ|Ê≠©:„ÅÇ„Çã|ÊØç:„ÅØ„ÅØ|Êñπ:„Åª„ÅÜ|Âåó:„Åç„Åü|Â¶π:„ÅÑ„ÇÇ„ÅÜ„Å®|ÊØé:„Åæ„ÅÑ|‰∏á:„Åæ„Çì|Êòé:„ÅÇ„Åã|È≥¥:„Å™|ÊØõ:„Åë|ÈñÄ:„ÇÇ„Çì|Â§ú:„Çà„Çã|Èáé:„ÅÆ|Âèã:„Å®„ÇÇ|Áî®:„Çà„ÅÜ|Êõú:„Çà„ÅÜ|Êù•:„Åç|Èáå:„Åï„Å®|ÁêÜ:„Çä|Ë©±:„ÅØ„Å™„Åó
        3|ÊÇ™:„Çè„Çã|ÂÆâ:„ÇÑ„Åô|Êöó:„Åè„Çâ|Âåª:„ÅÑ|Âßî:„ÅÑ|ÊÑè:„ÅÑ|ËÇ≤:„Åù„Å†|Âì°:„ÅÑ„Çì|Èô¢:„ÅÑ„Çì|È£≤:„ÅÆ|ÈÅã:„ÅØ„Åì|Ê≥≥:„Åä„Çà|ÈßÖ:„Åà„Åç|Â§Æ:„Åä„ÅÜ|Ê®™:„Çà„Åì|Â±ã:„ÇÑ|Ê∏©:„ÅÇ„Åü„Åü|Âåñ:„Åã|Ëç∑:„Å´|Áïå:„Åã„ÅÑ|Èñã:„ÅÇ|Èöé:„Åã„ÅÑ|ÂØí:„Åï„ÇÄ|ÊÑü:„Åã„Çì|Êº¢:„Åã„Çì|È§®:„Åã„Çì|Â≤∏:„Åç„Åó|Ëµ∑:„Åä|Êúü:„Åç|ÂÆ¢:„Åç„ÇÉ„Åè|Á©∂:„Åç„ÇÖ„ÅÜ|ÊÄ•:„ÅÑ„Åù|Á¥ö:„Åç„ÇÖ„ÅÜ|ÂÆÆ:„Åø„ÇÑ|ÁêÉ:„Åü„Åæ|Âéª:„Åï|Ê©ã:„ÅØ„Åó|Ê•≠:„Åé„Çá„ÅÜ|Êõ≤:„Åæ|Â±Ä:„Åç„Çá„Åè|ÈäÄ:„Åé„Çì|Âå∫:„Åè|Ëã¶:„Åè„Çã|ÂÖ∑:„Åê|Âêõ:„Åç„Åø|‰øÇ:„Åã„Åã„Çä|ËªΩ:„Åã„Çã|Ë°Ä:„Å°|Ê±∫:„Åç|Á†î:„Åë„Çì|Áúå:„Åë„Çì|Â∫´:„Åì|Êπñ:„Åø„Åö„ÅÜ„Åø|Âêë:„ÇÄ|Âπ∏:„Åó„ÅÇ„Çè|Ê∏Ø:„Åø„Å™„Å®|Âè∑:„Åî„ÅÜ|Ê†π:„Å≠|Á•≠:„Åæ„Å§|Áöø:„Åï„Çâ|‰ªï:„Åó|Ê≠ª:„Åó|‰Ωø:„Å§„Åã|Âßã:„ÅØ„Åò|Êåá:„ÇÜ„Å≥|Ê≠Ø:„ÅØ|Ë©©:„Åó|Ê¨°:„Å§„Åé|‰∫ã:„Åì„Å®|ÊåÅ:„ÇÇ|Âºè:„Åó„Åç|ÂÆü:„Åø|ÂÜô:„ÅÜ„Å§|ËÄÖ:„ÇÇ„ÅÆ|‰∏ª:„Åä„ÇÇ|ÂÆà:„Åæ„ÇÇ|Âèñ:„Å®|ÈÖí:„Åï„Åë|Âèó:„ÅÜ|Â∑û:„Åó„ÇÖ„ÅÜ|Êãæ:„Å≤„Çç|ÁµÇ:„Åä|Áøí:„Å™„Çâ|ÈõÜ:„ÅÇ„Å§|‰Ωè:„Åô|Èáç:„Åä„ÇÇ|ÂÆø:„ÇÑ„Å©|ÊâÄ:„Å®„Åì„Çç|Êöë:„ÅÇ„Å§|Âä©:„Åü„Åô|Êò≠:„Åó„Çá„ÅÜ|Ê∂à:„Åë|ÂïÜ:„Åó„Çá„ÅÜ|Á´†:„Åó„Çá„ÅÜ|Âãù:„Åã|‰πó:„ÅÆ|Ê§ç:„ÅÜ|Áî≥:„ÇÇ„ÅÜ|Ë∫´:„Åø|Á•û:„Åã„Åø|Áúü:„Åó„Çì|Ê∑±:„Åµ„Åã|ÈÄ≤:„Åô„Åô|‰∏ñ:„Çà|Êï¥:„Å®„Å®„ÅÆ|Êòî:„ÇÄ„Åã„Åó|ÂÖ®:„Åú„Çì|Áõ∏:„ÅÇ„ÅÑ|ÈÄÅ:„Åä„Åè|ÊÉ≥:„Åù„ÅÜ|ÊÅØ:„ÅÑ„Åç|ÈÄü:„ÅØ„ÇÑ|Êóè:„Åû„Åè|‰ªñ:„Åª„Åã|Êâì:„ÅÜ|ÂØæ:„Åü„ÅÑ|ÂæÖ:„Åæ|‰ª£:„Åã|Á¨¨:„Å†„ÅÑ|È°å:„Å†„ÅÑ|ÁÇ≠:„Åô„Åø|Áü≠:„Åø„Åò„Åã|Ë´á:„Å†„Çì|ÁùÄ:„Åç|Ê≥®:„Å°„ÇÖ„ÅÜ|Êü±:„ÅØ„Åó„Çâ|‰∏Å:„Å°„Çá„ÅÜ|Â∏≥:„Å°„Çá„ÅÜ|Ë™ø:„Åó„Çâ|ËøΩ:„Åä|ÂÆö:„Å¶„ÅÑ|Â∫≠:„Å´„Çè|Á¨õ:„Åµ„Åà|ÈâÑ:„Å¶„Å§|Ëª¢:„Åì„Çç|ÈÉΩ:„Åø„ÇÑ„Åì|Â∫¶:„Å©|Êäï:„Å™|Ë±Ü:„Åæ„ÇÅ|Â≥∂:„Åó„Åæ|ÊπØ:„ÇÜ|Áôª:„ÅÆ„Åº|Á≠â:„Å≤„Å®|Âãï:„ÅÜ„Åî|Á´•:„Å©„ÅÜ|Ëæ≤:„ÅÆ„ÅÜ|Ê≥¢:„Å™„Åø|ÈÖç:„ÅØ„ÅÑ|ÂÄç:„Å∞„ÅÑ|ÁÆ±:„ÅØ„Åì|Áïë:„ÅØ„Åü„Åë|Áô∫:„ÅØ„Å§|Âèç:„ÅØ„Çì|ÂùÇ:„Åï„Åã|Êùø:„ÅÑ„Åü|ÁöÆ:„Åã„Çè|ÊÇ≤:„Åã„Å™|Áæé:„ÅÜ„Å§„Åè|Èºª:„ÅØ„Å™|Á≠Ü:„Åµ„Åß|Ê∞∑:„Åì„Åä„Çä|Ë°®:„Åä„ÇÇ„Å¶|Áßí:„Å≥„Çá„ÅÜ|ÁóÖ:„ÇÑ„Åæ„ÅÑ|ÂìÅ:„Åó„Å™|Ë≤†:„Åæ|ÈÉ®:„Å∂|Êúç:„Åµ„Åè|Á¶è:„Åµ„Åè|Áâ©:„ÇÇ„ÅÆ|Âπ≥:„Åü„ÅÑ|Ëøî:„Åã„Åà|Âãâ:„Åπ„Çì|Êîæ:„ÅØ„Å™|Âë≥:„ÅÇ„Åò|ÂëΩ:„ÅÑ„ÅÆ„Å°|Èù¢:„ÇÅ„Çì|Âïè:„ÇÇ„Çì|ÂΩπ:„ÇÑ„Åè|Ëñ¨:„Åè„Åô„Çä|Áî±:„ÇÜ|Ê≤π:„ÅÇ„Å∂„Çâ|Êúâ:„ÅÇ|ÈÅä:„ÅÇ„Åù|‰∫à:„Çà|Áæä:„Å≤„Å§„Åò|Ê¥ã:„Çà„ÅÜ|Ëëâ:„ÅØ|ÈôΩ:„Çà„ÅÜ|Êßò:„Åï„Åæ|ËêΩ:„Åä|ÊµÅ:„Å™„Åå|ÊóÖ:„Åü„Å≥|‰∏°:„Çä„Çá„ÅÜ|Á∑ë:„Åø„Å©„Çä|Á§º:„Çå„ÅÑ|Âàó:„Çå„Å§|Á∑¥:„Çå„Çì|Ë∑Ø:„Çç|Âíå:„Çè
        4|ÊÑõ:„ÅÇ„ÅÑ|Ê°à:„ÅÇ„Çì|‰ª•:„ÅÑ|Ë°£:„Åì„Çç„ÇÇ|‰Ωç:„Åè„Çâ„ÅÑ|Âç∞:„ÅÑ„Çì|Ëã±:„Åà„ÅÑ|Ê†Ñ:„Åï„Åã|Â°©:„Åó„Åä|ÂÑÑ:„Åä„Åè|Âä†:„Åè„Çè|Êûú:„ÅØ|Ë≤®:„Åã|Ë™≤:„Åã|ËäΩ:„ÇÅ|Êîπ:„ÅÇ„Çâ„Åü|Ê¢∞:„Åã„ÅÑ|ÂÆ≥:„Åå„ÅÑ|Ë°ó:„Åæ„Å°|ÂêÑ:„Åã„Åè|Ë¶ö:„Åä„Åº|ÂÆå:„Åã„Çì|ÂÆò:„Åã„Çì|ÁÆ°:„Åè„Å†|Èñ¢:„Åã„Çì|Ë¶≥:„Åã„Çì|È°ò:„Å≠„Åå|Â∏å:„Åç|Â≠£:„Åç|Êóó:„ÅØ„Åü|Âô®:„ÅÜ„Å§„Çè|Ê©ü:„Åç|Ë≠∞:„Åé|Ê±Ç:„ÇÇ„Å®|Ê≥£:„Å™|Áµ¶:„Åç„ÇÖ„ÅÜ|Êåô:„ÅÇ|ÊºÅ:„Åé„Çá|ÂÖ±:„Å®„ÇÇ|Âçî:„Åç„Çá„ÅÜ|Èè°:„Åã„Åå„Åø|Á´∂:„Åç„Åù|Ê•µ:„Åç„Çè|Ë®ì:„Åè„Çì|Ëªç:„Åê„Çì|ÈÉ°:„Åê„Çì|ÂæÑ:„Åë„ÅÑ|ÊôØ:„Åë„ÅÑ|Ëä∏:„Åí„ÅÑ|Ê¨†:„Åã|Áµê:„ÇÄ„Åô|Âª∫:„Åü|ÂÅ•:„Åô„Åì|È®ì:„Åë„Çì|Âõ∫:„Åã„Åü|Âäü:„Åì„ÅÜ|Â•Ω:„Åô|ÂÄô:„Åì„ÅÜ|Â∫∑:„Åì„ÅÜ|Â∑Æ:„Åï|Ëèú:„Å™|ÊúÄ:„Åï„ÅÑ|Êùê:„Åñ„ÅÑ|Êò®:„Åï„Åè|Êú≠:„Åµ„Å†|Âà∑:„Åô|ÂØü:„Åï„Å§|ÂèÇ:„Åæ„ÅÑ|Áî£:„ÅÜ|Êï£:„Å°|ÊÆã:„ÅÆ„Åì|Ê∞è:„Åó|Âè∏:„Åó|Ë©¶:„Åü„ÇÅ|ÂÖê:„Åò|Ê≤ª:„Å™„Åä|Ëæû:„ÇÑ|Â§±:„Åó„Å§|ÂÄü:„Åã|Á®Æ:„Åü„Å≠|Âë®:„Åæ„Çè|Á•ù:„ÅÑ„Çè|È†Ü:„Åò„ÇÖ„Çì|Âàù:„ÅØ„Åò|Êùæ:„Åæ„Å§|Á¨ë:„Çè„Çâ|Âî±:„Å®„Å™|ÁÑº:„ÇÑ|ÁÖß:„Å¶|Ëá£:„Åó„Çì|‰ø°:„Åó„Çì|Êàê:„Å™|ÁúÅ:„Åó„Çá„ÅÜ|Ê∏Ö:„Åç„Çà|Èùô:„Åó„Åö|Â∏≠:„Åõ„Åç|Á©ç:„Å§|Êäò:„Åä|ÁØÄ:„Åµ„Åó|Ë™¨:„Å®|ÊµÖ:„ÅÇ„Åï|Êà¶:„Åü„Åü„Åã|ÈÅ∏:„Åà„Çâ|ÁÑ∂:„Åú„Çì|‰∫â:„ÅÇ„Çâ„Åù|ÂÄâ:„Åè„Çâ|Â∑£:„Åô|Êùü:„Åü„Å∞|ÂÅ¥:„Åå„Çè|Á∂ö:„Å§„Å•|Âçí:„Åù„Å§|Â≠´:„Åæ„Åî|Â∏Ø:„Åä„Å≥|Èöä:„Åü„ÅÑ|ÈÅî:„Åü„Å°|Âçò:„Åü„Çì|ÁΩÆ:„Åä|‰ª≤:„Å™„Åã|ÂÖÜ:„Å°„Çá„ÅÜ|‰Ωé:„Å≤„Åè|Â∫ï:„Åù„Åì|ÁöÑ:„Å¶„Åç|ÂÖ∏:„Å¶„Çì|‰ºù:„Å§„Åü|Âæí:„Å®|Âä™:„Å§„Å®|ÁÅØ:„Å≤|ÂÉç:„ÅØ„Åü„Çâ|Áâπ:„Å®„Åè|ÁÜ±:„ÅÇ„Å§|Âøµ:„Å≠„Çì|Êïó:„ÇÑ„Å∂|Ê¢Ö:„ÅÜ„ÇÅ|Âçö:„ÅØ„Åè|È£Ø:„ÇÅ„Åó|È£õ:„Å®|ÂøÖ:„Åã„Å™„Çâ|Á•®:„Å≤„Çá„ÅÜ|Ê®ô:„Å≤„Çá„ÅÜ|‰∏ç:„Åµ|Â§´:„Åä„Å£„Å®|‰ªò:„Å§|Â∫ú:„Åµ|ÂâØ:„Åµ„Åè|ÂÖµ:„Å∏„ÅÑ|Âà•:„Çè„Åã|Ëæ∫:„Å∏„Çì|Â§â:„Åã|‰æø:„Åπ„Çì|ÂåÖ:„Å§„Å§|Ê≥ï:„Åª„ÅÜ|Êúõ:„ÅÆ„Åû|Áâß:„Åº„Åè|Êú´:„Åô„Åà|Ê∫Ä:„Åæ„Çì|Êú™:„Åø|Ê∞ë:„Åü„Åø|ÁÑ°:„Å™|Á¥Ñ:„ÇÑ„Åè|Âãá:„ÇÜ„ÅÜ|Ë¶Å:„ÅÑ„Çã|È§ä:„ÇÑ„Åó„Å™|Êµ¥:„ÅÇ|Âà©:„Çä|Èô∏:„Çä„Åè|ËâØ:„Çà|Êñô:„Çä„Çá„ÅÜ|Èáè:„ÅØ„Åã|Ëº™:„Çè|È°û:„Çã„ÅÑ|‰ª§:„Çå„ÅÑ|ÂÜ∑:„Å§„ÇÅ|‰æã:„Åü„Å®|ÈÄ£:„Å§„Çâ|ËÄÅ:„Åä|Âä¥:„Çç„ÅÜ|Èå≤:„Çç„Åè|Ë≥Ä:„Åå|Áæ§:„ÇÄ|Âæ≥:„Å®„Åè|ÂØå:„Å®„Åø|Âüé:„Åó„Çç|Ëå®:„ÅÑ„Å∞„Çâ|Â™õ:„Å≤„ÇÅ|Â≤°:„Åä„Åã|ÊΩü:„Åã„Åü|Â≤ê:„Åç|ÁÜä:„Åè„Åæ|È¶ô:„Åã„Åä„Çä|‰Ωê:„Åï|Âüº:„Åï„ÅÑ|Â¥é:„Åï„Åç|Êªã:„Åò|Èπø:„Åó„Åã|Á∏Ñ:„Å™„Çè|‰∫ï:„ÅÑ|Ê≤ñ:„Åä„Åç|Ê†É:„Å®„Å°|Â•à:„Å™|Ê¢®:„Å™„Åó|Èò™:„ÅØ„Çì|Èòú:„Åµ
        5|Âõ≤:„Åã„Åì|Á¥Ä:„Åç|Âñú:„Çà„Çç„Åì|Êïë:„Åô„Åè|Âûã:„Åã„Åü|Ëà™:„Åì„ÅÜ|Âëä:„Å§|ÊÆ∫:„Åï„Å§|Â£´:„Åó|Âè≤:„Åó|Ë±°:„Åû„ÅÜ|Ë≥û:„Åó„Çá„ÅÜ|Ë≤Ø:„Å°„Çá|ÂÅú:„Å¶„ÅÑ|Â†Ç:„Å©„ÅÜ|Âæó:„Å®„Åè|ÊØí:„Å©„Åè|Ë≤ª:„Å≤|Á≤â:„Åì„Å™|ËÑà:„Åø„ÇÉ„Åè|Ê≠¥:„Çå„Åç|Âúß:„ÅÇ„Å§|Áßª:„ÅÜ„Å§|Âõ†:„ÅÑ„Çì|Ê∞∏:„Å™„Åå|Âñ∂:„ÅÑ„Å®„Å™|Ë°õ:„Åà„ÅÑ|Êòì:„ÇÑ„Åï|Áõä:„Åà„Åç|Ê∂≤:„Åà„Åç|Êºî:„Åà„Çì|Âøú:„Åä„ÅÜ|ÂæÄ:„Åä„ÅÜ|Ê°ú:„Åï„Åè„Çâ|ÂèØ:„Åã|‰ªÆ:„Åã„Çä|‰æ°:„Åã|Ê≤≥:„Åã„Çè|ÈÅé:„Åô|Ëß£:„Å®|Ê†º:„Åã„Åè|Á¢∫:„Åü„Åó|È°ç:„Åå„Åè|Âàä:„Åã„Çì|Âππ:„Åø„Åç|ÊÖ£:„Å™|Áúº:„ÇÅ|Âü∫:„ÇÇ„Å®|ÂØÑ:„Çà|Ë¶è:„Åç|ÊäÄ:„Çè„Åñ|Áæ©:„Åé|ÈÄÜ:„Åé„ÇÉ„Åè|‰πÖ:„Å≤„Åï|Êóß:„Åç„ÇÖ„ÅÜ|Â±Ö:„ÅÑ|Ë®±:„ÇÜ„Çã|Â¢É:„Åï„Åã„ÅÑ|Âùá:„Åç„Çì|Á¶Å:„Åç„Çì|Âè•:„Åè|Áµå:„Å∏|ÊΩî:„Åë„Å§|‰ª∂:„Åë„Çì|Èô∫:„Åë„Çè|Ê§ú:„Åë„Çì|Èôê:„Åã„Åé|Áèæ:„ÅÇ„Çâ„Çè|Ê∏õ:„Å∏|ÊïÖ:„Åµ„Çã|ÂÄã:„Åì|Ë≠∑:„Åæ„ÇÇ|Âäπ:„Åì„ÅÜ|Âéö:„ÅÇ„Å§|ËÄï:„Åü„Åå„ÇÑ|Èâ±:„Åì„ÅÜ|Êßã:„Åã„Åæ|Ëàà:„Åä„Åì|Ë¨õ:„Åì„ÅÜ|Ê∑∑:„Åæ|Êüª:„Åï|ÂÜç:„Åµ„Åü„Åü|ÁÅΩ:„Çè„Åñ„Çè|Â¶ª:„Å§„Åæ|Êé°:„Å®|Èöõ:„Åï„ÅÑ|Âú®:„ÅÇ|Ë≤°:„Åñ„ÅÑ|ÁΩ™:„Å§„Åø|Èõë:„Åñ„Å§|ÈÖ∏:„Åï„Çì|Ë≥õ:„Åï„Çì|ÊîØ:„Åï„Åï|Âøó:„Åì„Åì„Çç„Åñ„Åó|Êûù:„Åà„Å†|Â∏´:„Åó|Ë≥á:„Åó|È£º:„Åã|Á§∫:„Åó„ÇÅ|‰ºº:„Å´|Ë≠ò:„Åó„Åç|Ë≥™:„Åó„Å§|Ëàé:„Åó„ÇÉ|Ë¨ù:„ÅÇ„ÇÑ„Åæ|Êéà:„Åï„Åö|‰øÆ:„Åä„Åï|Ëø∞:„ÅÆ|Ë°ì:„Åò„ÇÖ„Å§|Ê∫ñ:„Åò„ÇÖ„Çì|Â∫è:„Åò„Çá|Êãõ:„Åæ„Å≠|Ë®º:„Åó„Çá„ÅÜ|Êù°:„Åò„Çá„ÅÜ|Áä∂:„Åò„Çá„ÅÜ|Â∏∏:„Å§„Å≠|ÊÉÖ:„Å™„Åï|Áπî:„Åä|ËÅ∑:„Åó„Çá„Åè|Âà∂:„Åõ„ÅÑ|ÊÄß:„Åõ„ÅÑ|Êîø:„Åæ„Å§„Çä„Åî„Å®|Âã¢:„ÅÑ„Åç„Åä|Á≤æ:„Åõ„ÅÑ|Ë£Ω:„Åõ„ÅÑ|Á®é:„Åú„ÅÑ|Ë≤¨:„Åõ|Á∏æ:„Åõ„Åç|Êé•:„Å§|Ë®≠:„ÇÇ„ÅÜ|Áµ∂:„Åü|Á•ñ:„Åù|Á¥†:„Åù|Á∑è:„Åù„ÅÜ|ÈÄ†:„Å§„Åè|ÂÉè:„Åû„ÅÜ|Â¢ó:„Åµ|Ââá:„Åù„Åè|Ê∏¨:„ÅØ„Åã|Â±û:„Åû„Åè|Áéá:„Çä„Å§|Êêç:„Åù„Çì|Ë≤∏:„Åã|ÊÖã:„Åü„ÅÑ|Âõ£:„Å†„Çì|Êñ≠:„Åì„Å®„Çè|ÁØâ:„Åç„Åö|Âºµ:„ÅØ|Êèê:„Å¶„ÅÑ|Á®ã:„Åª„Å©|ÈÅ©:„Å¶„Åç|Áµ±:„Å®„ÅÜ|ÈäÖ:„Å©„ÅÜ|Â∞é:„Åø„Å°„Å≥|Áã¨:„Å≤„Å®|‰ªª:„Åæ„Åã|ÁáÉ:„ÇÇ|ËÉΩ:„ÅÆ„ÅÜ|Á†¥:„ÇÑ„Å∂|ÁäØ:„Åä„Åã|Âà§:„ÅØ„Çì|Áâà:„ÅØ„Çì|ÊØî:„Åè„Çâ|ËÇ•:„Åì|Èùû:„Å≤|ÂÇô:„Åù„Å™|Ë©ï:„Å≤„Çá„ÅÜ|Ë≤ß:„Åæ„Åö|Â∏É:„Å¨„ÅÆ|Â©¶:„Åµ|Ê≠¶:„Å∂|Âæ©:„Åµ„Åè|Ë§á:„Åµ„Åè|‰ªè:„Åª„Å®„Åë|Á∑®:„ÅÇ|ÂºÅ:„Åπ„Çì|‰øù:„Åü„ÇÇ|Â¢ì:„ÅØ„Åã|Â†±:„ÇÄ„Åè|Ë±ä:„ÇÜ„Åü|Èò≤:„Åµ„Åõ|Ë≤ø:„Åº„ÅÜ|Êö¥:„ÅÇ„Å∞|Âãô:„Å§„Å®|Â§¢:„ÇÜ„ÇÅ|Ëø∑:„Åæ„Çà|Á∂ø:„Çè„Åü|Ëº∏:„ÇÜ|‰Ωô:„ÅÇ„Åæ|ÂÆπ:„Çà„ÅÜ|Áï•:„Çä„ÇÉ„Åè|Áïô:„Å®|È†ò:„Çä„Çá„ÅÜ|Âø´:„Åã„ÅÑ
        6|ËÉÉ:„ÅÑ|ËÖ∏:„Å°„Çá„ÅÜ|ÊÅ©:„Åä„Çì|Âà∏:„Åë„Çì|Êâø:„Åó„Çá„ÅÜ|Ëàå:„Åó„Åü|Èä≠:„Åú„Å´|ÈÄÄ:„Åó„Çä„Åû|Êïµ:„Å¶„Åç|‰øµ:„Åü„Çè„Çâ|È†ê:„ÅÇ„Åö|Áï∞:„Åì„Å®|ÈÅ∫:„ÅÑ|Âüü:„ÅÑ„Åç|ÂÆá:„ÅÜ|Êò†:„ÅÜ„Å§|Âª∂:„ÅÆ|Ê≤ø:„Åù|Êàë:„Çè„Çå|ÁÅ∞:„ÅØ„ÅÑ|Êã°:„Åã„Åè|Èù©:„Åã„Çè|Èñ£:„Åã„Åè|Ââ≤:„Çè|Ê†™:„Åã„Å∂|Âπ≤:„Åª|Â∑ª:„Åæ|Áúã:„Åã„Çì|Á∞°:„Åã„Çì|Âç±:„ÅÇ„Å∂|Êú∫:„Å§„Åè„Åà|Ë≤¥:„Å®„ÅÜ„Å®|Áñë:„ÅÜ„Åü„Åå|Âê∏:„Åô|‰æõ:„Å®„ÇÇ|ËÉ∏:„ÇÄ„Å≠|ÈÉ∑:„Åç„Çá„ÅÜ|Âã§:„Å§„Å®|Á≠ã:„Åô„Åò|Á≥ª:„Åë„ÅÑ|Êï¨:„ÅÜ„ÇÑ„Åæ|Ë≠¶:„Åë„ÅÑ|Âäá:„Åí„Åç|ÊøÄ:„ÅØ„Åí|Á©¥:„ÅÇ„Å™|Áµπ:„Åç„Å¨|Ê®©:„Åë„Çì|ÊÜ≤:„Åë„Çì|Ê∫ê:„Åø„Å™„ÇÇ„Å®|Âé≥:„Åç„Å≥|Â∑±:„Åä„ÅÆ„Çå|Âëº:„Çà|Ë™§:„ÅÇ„ÇÑ„Åæ|Âêé:„Åì„ÅÜ|Â≠ù:„Åì„ÅÜ|Áöá:„Åì„ÅÜ|Á¥Ö:„Åπ„Å´|Èôç:„Åä|Èãº:„ÅØ„Åå„Å≠|Âàª:„Åç„Åñ|Á©Ä:„Åì„Åè|È™®:„Åª„Å≠|Âõ∞:„Åì„Åæ|Á†Ç:„Åô„Å™|Â∫ß:„Åô„Çè|Ê∏à:„Åô|Ë£Å:„Åï„Å∞|Á≠ñ:„Åï„Åè|ÂÜä:„Åï„Åè|Ëöï:„Åã„ÅÑ„Åì|Ëá≥:„ÅÑ„Åü|ÁßÅ:„Çè„Åü„Åó|Âßø:„Åô„Åå„Åü|Ë¶ñ:„Åó|Ë©û:„Åó|Ë™å:„Åó|Á£Å:„Åò|Â∞Ñ:„ÅÑ|Êç®:„Åô|Â∞∫:„Åó„ÇÉ„Åè|Ëã•:„Çè„Åã|Ê®π:„Åç|Âèé:„Åä„Åï|ÂÆó:„Åó„ÇÖ„ÅÜ|Â∞±:„Å§|Ë°Ü:„Åó„ÇÖ„ÅÜ|Âæì:„Åó„Åü„Åå|Á∏¶:„Åü„Å¶|Á∏Æ:„Å°„Å¢|ÁÜü:„ÅÜ|Á¥î:„Åò„ÇÖ„Çì|Âá¶:„Åó„Çá|ÁΩ≤:„Åó„Çá|Ë´∏:„ÇÇ„Çç|Èô§:„ÅÆ„Åû|Â∞Ü:„Åó„Çá„ÅÜ|ÂÇ∑:„Åç„Åö|Èöú:„Åï„Çè|Ëí∏:„ÇÄ|Èáù:„ÅØ„Çä|‰ªÅ:„Åò„Çì|ÂûÇ:„Åü|Êé®:„Åä|ÂØ∏:„Åô„Çì|Áõõ:„ÇÇ|ËÅñ:„Åõ„ÅÑ|Ë™†:„Åõ„ÅÑ|ÂÆ£:„Åõ„Çì|Â∞Ç:„ÇÇ„Å£„Å±|Ê≥â:„ÅÑ„Åö„Åø|Ê¥ó:„ÅÇ„Çâ|Êüì:„Åù|ÂñÑ:„Åú„Çì|Â•è:„Åã„Å™|Á™ì:„Åæ„Å©|Ââµ:„Å§„Åè|Ë£Ö:„Çà„Åù„Åä|Â±§:„Åù„ÅÜ|Êìç:„ÅÇ„ÇÑ„Å§|Ëîµ:„Åè„Çâ|Ëáì:„Åû„ÅÜ|Â≠ò:„Åù„Çì|Â∞ä:„Å®„ÅÜ„Å®|ÂÆÖ:„Åü„Åè|ÊãÖ:„Å´„Å™|Êé¢:„Åï„Åå|Ë™ï:„Åü„Çì|ÊÆµ:„Å†„Çì|Êöñ:„ÅÇ„Åü„Åü|ÂÄ§:„Å≠|ÂÆô:„Å°„ÇÖ„ÅÜ|Âø†:„Å°„ÇÖ„ÅÜ|Ëëó:„ÅÇ„Çâ„Çè|Â∫Å:„Å°„Çá„ÅÜ|È†Ç:„ÅÑ„Åü„Å†„Åç|ÊΩÆ:„Åó„Åä|Ë≥É:„Å°„Çì|Áóõ:„ÅÑ„Åü|Â±ï:„Å¶„Çì|Ë®é:„ÅÜ|ÂÖö:„Å®„ÅÜ|Á≥ñ:„Å®„ÅÜ|Â±ä:„Å®„Å©|Èõ£:„ÇÄ„Åö„Åã|‰π≥:„Å°„Å°|Ë™ç:„Åø„Å®|Á¥ç:„Åä„Åï|ËÑ≥:„ÅÆ„ÅÜ|Ê¥æ:„ÅØ|Êãù:„Åä„Åå|ËÉå:„Åõ|ËÇ∫:„ÅØ„ÅÑ|‰ø≥:„ÅØ„ÅÑ|Áè≠:„ÅØ„Çì|Êô©:„Å∞„Çì|Âê¶:„ÅÑ„Å™|Êâπ:„Å≤|Áßò:„Å≤|ËÖπ:„ÅØ„Çâ|Â•Æ:„Åµ„Çã|‰∏¶:„Å™„Çâ|Èôõ:„Å∏„ÅÑ|Èñâ:„Åó|Áâá:„Åã„Åü|Ë£ú:„Åä„Åé„Å™|ÊöÆ:„Åè|ÂÆù:„Åü„Åã„Çâ|Ë®™:„Åä„Å®„Åö|‰∫°:„Å™|Âøò:„Çè„Åô|Ê£í:„Åº„ÅÜ|Êûö:„Åæ„ÅÑ|Âπï:„Åæ„Åè|ÂØÜ:„Åø„Å§|Áõü:„ÇÅ„ÅÑ|Ê®°:„ÇÇ|Ë®≥:„Çè„Åë|ÈÉµ:„ÇÜ„ÅÜ|ÂÑ™:„ÇÑ„Åï|Âπº:„Åä„Åï„Å™|Ê¨≤:„Åª|Áøå:„Çà„Åè|‰π±:„Åø„Å†|Âçµ:„Åü„Åæ„Åî|Ë¶ß:„Çâ„Çì|Ë£è:„ÅÜ„Çâ|Âæã:„Çä„Å§|Ëá®:„ÅÆ„Åû|Êúó:„Çç„ÅÜ|Ë´ñ:„Çç„Çì|ÊèÆ:„Åç
        `;

        const searchDB = [];
        const gradeColors = { 1:"#FF8A65", 2:"#FFD54F", 3:"#4FC3F7", 4:"#81C784", 5:"#BA68C8", 6:"#7986CB" };

        rawData.trim().split('\n').forEach(line => {
            line = line.trim();
            if(!line) return;
            const parts = line.split('|');
            const grade = parseInt(parts[0]);
            
            for(let i=1; i<parts.length; i++) {
                const entry = parts[i].split(':');
                searchDB.push({
                    char: entry[0],
                    reading: entry[1] || "",
                    grade: grade
                });
            }
        });

        function getAllStats() {
            let totalStars = 0;
            let totalCrowns = 0;
            for (let g = 1; g <= 6; g++) {
                const practice = JSON.parse(localStorage.getItem(`kanjiMasterPractice_${g}`)) || {};
                const test = JSON.parse(localStorage.getItem(`kanjiMasterTest_${g}`)) || {};
                totalStars += Object.keys(practice).length;
                totalCrowns += Object.keys(test).length;
            }
            return { totalStars, totalCrowns };
        }

        function getPortalSettings() {
            const def = { currentCourse: "A" };
            try { return JSON.parse(localStorage.getItem(PORTAL_KEY)) || def; } catch(e) { return def; }
        }
        function savePortalSettings(s) { localStorage.setItem(PORTAL_KEY, JSON.stringify(s)); }

        function updatePortalUI() {
            const stats = getAllStats();
            const settings = getPortalSettings();
            
            const level = Math.floor(stats.totalStars / STARS_PER_LEVEL);
            const nextLevelStars = (level + 1) * STARS_PER_LEVEL - stats.totalStars;
            const auraLevel = Math.min(Math.floor(stats.totalCrowns / CROWNS_PER_AURA), 3);

            const courseData = COURSES[settings.currentCourse];
            const charIndex = Math.min(level, courseData.chars.length - 1);
            document.getElementById('current-char').textContent = courseData.chars[charIndex];
            document.getElementById('current-lvl').textContent = level;
            document.getElementById('next-xp').textContent = nextLevelStars;
            
            const auraEl = document.getElementById('aura-effect');
            auraEl.className = 'aura-bg'; 
            if(auraLevel > 0) auraEl.classList.add(`aura-lv1`);
            if(auraLevel >= 2) auraEl.classList.remove('aura-lv1'), auraEl.classList.add('aura-lv2');
            if(auraLevel >= 3) auraEl.classList.remove('aura-lv2'), auraEl.classList.add('aura-lv3');
            
            const pct = ((STARS_PER_LEVEL - nextLevelStars) / STARS_PER_LEVEL) * 100;
            document.getElementById('xp-fill').style.width = pct + "%";

            // Â≠¶Âπ¥„Åî„Å®„ÅÆÈÄ≤Êçó„Éê„ÉºÊõ¥Êñ∞Ôºà„Åì„Åì„Åå‰ªäÂõûËøΩÂä†„Åó„ÅüÊ©üËÉΩÔºâ
            updateGradeProgress();
        }

        function updateGradeProgress() {
            const gradeCounts = {};
            searchDB.forEach(item => {
                if(!gradeCounts[item.grade]) gradeCounts[item.grade] = 0;
                gradeCounts[item.grade]++;
            });

            for(let g=1; g<=6; g++) {
                const practice = JSON.parse(localStorage.getItem(`kanjiMasterPractice_${g}`)) || {};
                const current = Object.keys(practice).length;
                const total = gradeCounts[g] || 0;
                const pct = total > 0 ? Math.floor((current / total) * 100) : 0;
                
                const bar = document.getElementById(`g-bar-${g}`);
                const txt = document.getElementById(`g-text-${g}`);
                if(bar && txt) {
                    bar.style.width = pct + "%";
                    txt.textContent = `${current} / ${total} (${pct}%)`;
                    if(pct === 100) txt.style.color = "#E91E63";
                }
            }
        }

        function openCourseModal() {
            const list = document.getElementById('course-list');
            list.innerHTML = '';
            const settings = getPortalSettings();
            for (const [key, data] of Object.entries(COURSES)) {
                const div = document.createElement('div');
                div.className = `course-option ${key === settings.currentCourse ? 'active' : ''}`;
                div.onclick = () => {
                    settings.currentCourse = key;
                    savePortalSettings(settings);
                    updatePortalUI();
                    document.getElementById('course-modal').style.display = 'none';
                    showXPGainEffect(window.innerWidth/2, window.innerHeight/2, "Â§âË∫´ÔºÅ");
                };
                div.innerHTML = `<span style="font-size:1.5rem; margin-right:10px;">${data.chars[0]}</span> <b>${data.name}</b>`;
                list.appendChild(div);
            }
            document.getElementById('course-modal').style.display = 'flex';
        }

        function showXPGainEffect(x, y, text) {
            const effect = document.createElement('div');
            effect.className = 'xp-gain-effect';
            effect.textContent = text;
            effect.style.left = (x - 40) + 'px';
            effect.style.top = y + 'px';
            document.body.appendChild(effect);
            setTimeout(() => effect.remove(), 1200);
        }

        function showResetConfirm(){ document.getElementById('reset-confirm-overlay').style.display='flex'; }
        function confirmReset() { localStorage.clear(); location.reload(); }

        // --- App Logic ---
        let currentGrade = 0;
        let currentAppKanjiData = [];
        let writer;
        let currentChar = null;
        let currentMode = 'practice';
        
        function launchApp(grade) {
            currentGrade = grade;
            currentAppKanjiData = searchDB.filter(item => item.grade === grade);
            document.getElementById('portal-view').style.display = 'none';
            document.getElementById('app-view').style.display = 'block';
            document.body.classList.add('app-mode');
            document.querySelector('#title-screen-app .game-title').innerHTML = `${grade}„Å≠„Çì„Åõ„ÅÑ<br>„Åã„Çì„Åò„Éû„Çπ„Çø„Éº`;
            showAppScreen('title-screen-app');
        }

        function exitApp() {
            document.getElementById('app-view').style.display = 'none';
            document.getElementById('portal-view').style.display = 'block';
            document.body.classList.remove('app-mode');
            updatePortalUI();
        }

        function showAppScreen(id) {
            document.querySelectorAll('#app-view .screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'list-screen') {
                document.getElementById('app-search-box').value = '';
                renderAppList(currentAppKanjiData);
            }
        }

        function selectMode(mode) {
            playSound('click');
            currentMode = mode;
            showAppScreen('list-screen');
        }

        function filterAppList() {
            const query = document.getElementById('app-search-box').value.trim();
            if(!query) { renderAppList(currentAppKanjiData); return; }
            const filtered = currentAppKanjiData.filter(i => i.char.includes(query) || i.reading.includes(query));
            renderAppList(filtered);
        }

        function renderAppList(data) {
            const grid = document.getElementById('kanji-grid');
            grid.innerHTML = '';
            
            const badge = document.getElementById('mode-display');
            const pPractice = JSON.parse(localStorage.getItem(`kanjiMasterPractice_${currentGrade}`)) || {};
            const pTest = JSON.parse(localStorage.getItem(`kanjiMasterTest_${currentGrade}`)) || {};
            const targetP = (currentMode==='practice') ? pPractice : pTest;
            
            let clearedCount = 0;
            currentAppKanjiData.forEach(k => { if(targetP[k.char]) clearedCount++; });
            document.getElementById('star-counter').textContent = clearedCount;
            document.getElementById('max-count').textContent = currentAppKanjiData.length;

            badge.textContent = currentMode === 'practice' ? "‚≠ê „Çå„Çì„Åó„ÇÖ„ÅÜ„É¢„Éº„Éâ" : "üëë „ÉÜ„Çπ„Éà„É¢„Éº„Éâ";
            badge.style.color = currentMode === 'practice' ? "#4CAF50" : "#F44336";

            data.forEach(item => {
                const isCleared = targetP[item.char];
                const div = document.createElement('div');
                div.className = 'kanji-card';
                if(isCleared) div.classList.add(currentMode==='practice'?'cleared-practice':'cleared-test');
                div.innerHTML = `${item.char}<div class="mark star-mark">‚≠ê</div><div class="mark crown-mark">üëë</div>`;
                div.onclick = () => { playSound('click'); startWriting(item); };
                grid.appendChild(div);
            });
        }

        function startWriting(item) {
            currentChar = item;
            showAppScreen('practice-screen');
            document.getElementById('result-overlay').classList.remove('active');
            
            const isTest = (currentMode === 'test');
            const screen = document.getElementById('practice-screen');
            const msg = document.getElementById('message-area');
            
            if(isTest) {
                screen.classList.add('test-bg');
                msg.innerText = "„Åì„ÅÆ „Åã„Çì„Åò „Çí „Åã„Åì„ÅÜÔºÅ";
                msg.style.color = "#C62828";
                document.getElementById('current-reading').innerText = item.reading;
            } else {
                screen.classList.remove('test-bg');
                msg.innerText = "„Å™„Åû„Å£„Å¶„Åø„Çà„ÅÜÔºÅ";
                msg.style.color = "#006064";
                document.getElementById('current-reading').innerText = `${item.char} (${item.reading})`;
            }

            document.getElementById('character-target-div').innerHTML = '';
            writer = HanziWriter.create('character-target-div', item.char, {
                width: 300, height: 300, padding: 10,
                showOutline: !isTest, strokeAnimationSpeed: 1, delayBetweenStrokes: 200,
                radicalColor: '#168F16', drawingWidth: 25, outlineColor: '#DDD',
                strokeColor: '#333', highlightColor: '#FF7043', showHintAfterMisses: 1,
                charDataLoader: (char, onComplete) => {
                    fetch(`https://cdn.jsdelivr.net/gh/chanind/hanzi-writer-data-jp@master/data/${char}.json`)
                    .then(r => r.json()).then(onComplete)
                    .catch(() => {
                        fetch(`https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${char}.json`)
                        .then(r => r.json()).then(onComplete);
                    });
                }
            });
            writer.quiz({
                onMistake: () => { playSound('error'); msg.innerText = isTest ? "„Åä„Åó„ÅÑÔºÅ" : "„Åì„Åì„Å†„ÇàÔºÅ"; msg.style.color="#D32F2F"; },
                onCorrectStroke: () => { playSound('success'); msg.innerText = "„ÅÑ„ÅÑ„Å≠ÔºÅ"; msg.style.color="#388E3C"; },
                onComplete: handleComplete
            });
        }

        function handleComplete() {
            const oldStats = getAllStats();
            const oldLevel = Math.floor(oldStats.totalStars / STARS_PER_LEVEL);
            
            const key = (currentMode==='practice') ? `kanjiMasterPractice_${currentGrade}` : `kanjiMasterTest_${currentGrade}`;
            const data = JSON.parse(localStorage.getItem(key)) || {};
            const isFirst = !data[currentChar.char];
            data[currentChar.char] = true;
            localStorage.setItem(key, JSON.stringify(data));

            const newStats = getAllStats();
            const newLevel = Math.floor(newStats.totalStars / STARS_PER_LEVEL);

            setTimeout(() => {
                if (isFirst && newLevel > oldLevel) {
                    playSound('levelup');
                    const popup = document.getElementById('levelup-popup');
                    const settings = getPortalSettings();
                    const chars = COURSES[settings.currentCourse].chars;
                    document.getElementById('levelup-emoji').innerText = chars[Math.min(newLevel, chars.length-1)];
                    document.getElementById('levelup-char').innerText = `Lv.${newLevel} „Å´„Å™„Å£„Åü„ÇàÔºÅ`;
                    popup.classList.add('show');
                    setTimeout(() => {
                        popup.classList.remove('show');
                        document.getElementById('result-overlay').classList.add('active');
                    }, 3000);
                } else {
                    playSound('complete');
                    document.getElementById('result-overlay').classList.add('active');
                }
            }, 800);
        }

        function goNext() {
            const idx = currentAppKanjiData.findIndex(k => k.char === currentChar.char);
            if(idx >= 0 && idx < currentAppKanjiData.length - 1) startWriting(currentAppKanjiData[idx+1]);
            else { alert("„Åì„Çå„Åß„Åä„Åó„Åæ„ÅÑÔºÅ"); showAppScreen('list-screen'); }
        }
        function retry() { startWriting(currentChar); }

        let audioCtx;
        function playSound(type) {
            if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            const t = audioCtx.currentTime;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            
            if(type==='success') {
                o.frequency.setValueAtTime(800, t); o.frequency.exponentialRampToValueAtTime(1200, t+0.1);
                g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
                o.start(t); o.stop(t+0.1);
            } else if(type==='complete') {
                o.frequency.setValueAtTime(500, t); o.frequency.linearRampToValueAtTime(800, t+0.1);
                g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.3);
                o.start(t); o.stop(t+0.3);
            } else if(type==='click') {
                o.frequency.setValueAtTime(600, t); o.frequency.exponentialRampToValueAtTime(300, t+0.05);
                g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.05);
                o.start(t); o.stop(t+0.05);
            } else if(type==='error') {
                o.type = 'sawtooth';
                o.frequency.setValueAtTime(150, t); o.frequency.linearRampToValueAtTime(100, t+0.2);
                g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.2);
                o.start(t); o.stop(t+0.2);
            } else if(type==='levelup') {
                [523, 659, 784, 1046].forEach((f, i) => {
                    const os = audioCtx.createOscillator();
                    const gn = audioCtx.createGain();
                    os.connect(gn); gn.connect(audioCtx.destination);
                    os.frequency.value = f;
                    gn.gain.setValueAtTime(0.2, t + i*0.1);
                    gn.gain.exponentialRampToValueAtTime(0.01, t + i*0.1 + 0.4);
                    os.start(t + i*0.1); os.stop(t + i*0.1 + 0.4);
                });
            }
        }

        const sInput = document.getElementById('search-input');
        const sRes = document.getElementById('search-results');
        sInput.addEventListener('input', (e) => {
            const v = e.target.value.trim();
            sRes.innerHTML = '';
            if(!v) { sRes.style.display='none'; return; }
            const hits = searchDB.filter(i => i.char.includes(v) || i.reading.includes(v)).slice(0,10);
            if(hits.length) {
                hits.forEach(m => {
                    const d = document.createElement('div');
                    d.className = 'result-card';
                    d.innerHTML = `<div><span style="font-size:1.2rem; color:${gradeColors[m.grade]}">${m.char}</span> <span style="font-size:0.8rem; color:#666;">${m.grade}Âπ¥</span></div>`;
                    d.onclick = () => { sRes.style.display='none'; sInput.value=''; launchApp(m.grade); };
                    sRes.appendChild(d);
                });
                sRes.style.display = 'block';
            }
        });
        document.body.addEventListener('click', (e) => { if(!e.target.closest('.search-container')) sRes.style.display='none'; });

        updatePortalUI();
  </script>
 </body>
</html>
