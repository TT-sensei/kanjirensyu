<!doctype html>
<html lang="ja">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å°å­¦æ ¡ã‹ã‚“ã˜ãƒã‚¹ã‚¿ãƒ¼ çµ±åˆå®Œå…¨ç‰ˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
  <style>
    /* --- 1. åŸºæœ¬è¨­å®š --- */
    body { box-sizing: border-box; }
    :root {
        --bg-color: #F4F7F6;
        --g1-color: #FF8A65; --g2-color: #FFD54F; --g3-color: #4FC3F7;
        --g4-color: #81C784; --g5-color: #BA68C8; --g6-color: #7986CB;
        --app-bg: #fff;
    }
    body {
        font-family: 'Mochiy Pop One', sans-serif;
        background-color: var(--bg-color);
        margin: 0; padding: 0; color: #37474F;
        height: 100vh; display: flex; flex-direction: column; overflow: hidden; /* ã‚¢ãƒ—ãƒªç”»é¢ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
    }

    /* --- 2. ãƒãƒ¼ã‚¿ãƒ«ç”»é¢ï¼ˆãƒ›ãƒ¼ãƒ ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    #portal-screen {
        flex: 1; display: flex; flex-direction: column; overflow-y: auto; /* ãƒãƒ¼ã‚¿ãƒ«ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«OK */
        height: 100%;
    }

    /* XPãƒãƒ¼ */
    #xp-bar-container {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        padding: 10px 15px; display: flex; align-items: center; justify-content: space-between;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 20; height: 90px; flex-shrink: 0;
        border-bottom: 3px solid #4FC3F7;
    }
    .xp-info { display: flex; align-items: center; gap: 15px; flex-grow: 1; }
    .char-icon { 
        font-size: 3.5rem; cursor: pointer; 
        animation: bounce 2s infinite; margin-left: 5px;
    }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .xp-stats { flex-grow: 1; display: flex; flex-direction: column; gap: 2px; }
    .progress-track {
        height: 16px; background: #ddd; border-radius: 8px; width: 95%; overflow: hidden;
    }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #4FC3F7, #29B6F6); width: 0%; transition: width 0.5s; }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
        background: rgba(255,255,255,0.95); padding: 10px 20px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10;
    }
    .logo { font-size: 1.2rem; font-weight: bold; color: #2c3e50; }
    
    /* å­¦å¹´ã‚«ãƒ¼ãƒ‰ */
    .grade-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px; padding: 20px; max-width: 800px; margin: 0 auto;
    }
    .grade-card {
        background: white; border-radius: 20px; padding: 15px; text-align: center;
        cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s;
        border-bottom: 5px solid #ccc;
    }
    .grade-card:active { transform: scale(0.95); }
    .card-icon { font-size: 3rem; margin-bottom: 5px; }
    .card-title { font-size: 1rem; font-weight: bold; color: #444; }

    /* --- 3. ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ»æ³¨æ„äº‹é …ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¾©æ´»ï¼ï¼‰ --- */
    .footer-content {
        max-width: 800px; margin: 0 auto; padding: 20px; padding-bottom: 100px;
    }
    .footer-note {
        padding: 15px; background-color: #E8F4FF; border-radius: 12px;
        font-size: 0.8rem; color: #446688; line-height: 1.6;
        border-left: 4px solid #4FC3F7; margin-bottom: 20px; font-family: sans-serif;
    }
    .app-credits-container {
        font-family: sans-serif; background: #fff; padding: 20px;
        border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.85rem;
    }
    .credit-warning-box {
        background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404;
        padding: 10px; border-radius: 6px; margin-bottom: 15px;
    }
    .credit-list { list-style: none; padding: 0; }
    .credit-item { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
    .credit-name { font-weight: bold; color: #2c3e50; }
    .credit-desc { font-size: 0.9em; color: #555; margin-left: 10px; }
    .license-details { margin-top: 5px; border: 1px solid #ddd; }
    .license-summary { background: #f7f7f7; padding: 5px; cursor: pointer; }
    .license-full-text { padding: 10px; background: #fafafa; white-space: pre-wrap; font-family: monospace; max-height: 150px; overflow-y: auto; font-size: 0.75rem; }

    /* --- 4. ã‚¢ãƒ—ãƒªç”»é¢ï¼ˆç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼‰ --- */
    #app-screen {
        display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        flex-direction: column; height: 100%; background: var(--app-bg);
    }
    #app-header {
        padding: 10px; background: #fff; display: flex; align-items: center; justify-content: space-between;
        border-bottom: 2px solid #eee;
    }
    .back-btn {
        background: #eee; border: none; padding: 8px 16px; border-radius: 20px;
        font-family: inherit; font-weight: bold; cursor: pointer;
    }
    #canvas-area {
        flex: 1; position: relative; display: flex; justify-content: center; align-items: center;
        background-image: linear-gradient(0deg, transparent 49%, #ddd 50%, transparent 51%),
                          linear-gradient(90deg, transparent 49%, #ddd 50%, transparent 51%);
        background-size: 100% 100%; 
        border: 10px solid #8D6E63; margin: 10px; border-radius: 4px; box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
    }
    #drawing-board { width: 300px; height: 300px; cursor: crosshair; }
    
    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
    .controls {
        padding: 15px; background: #fff; display: flex; flex-direction: column; gap: 10px;
        box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
    }
    .char-nav { display: flex; justify-content: center; align-items: center; gap: 20px; }
    .nav-btn {
        width: 50px; height: 50px; border-radius: 50%; border: none; background: #4FC3F7;
        color: white; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 0 #0288D1;
    }
    .nav-btn:active { transform: translateY(4px); box-shadow: none; }
    
    .status-panel { text-align: center; }
    #current-kanji-display { font-size: 1.5rem; color: #555; }
    #message-area { height: 20px; color: #ff5252; font-weight: bold; font-size: 0.9rem; }

    /* ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãªã© */
    #levelup-popup {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
        background: #FFD54F; padding: 30px; border-radius: 20px; text-align: center;
        border: 4px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100;
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #levelup-popup.show { transform: translate(-50%, -50%) scale(1); }

  </style>
 </head>
 <body>

  <div style="display:none;">AudioContext Ready</div>

  <div id="portal-screen">
      <div id="xp-bar-container">
       <div class="xp-info">
        <div class="char-icon" id="current-char">ğŸ¥š</div>
        <div class="xp-stats">
         <div style="font-weight:bold; font-size:0.9rem;">Lv.<span id="current-lvl">0</span></div>
         <div class="progress-track"><div class="progress-fill" id="xp-fill"></div></div>
         <div style="font-size:0.75rem; text-align:right;">ã‚ã¨<span id="next-xp">5</span>å›</div>
        </div>
       </div>
      </div>

      <header>
       <div class="logo">ğŸ« æ¼¢å­—ãƒã‚¹ã‚¿ãƒ¼</div>
       <button onclick="resetData()" style="font-size:0.7rem; padding:5px 10px; background:#ffebee; border:none; border-radius:10px; color:#c62828;">ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>
      </header>

      <div style="text-align:center; margin-top:20px;">
        <h2 style="margin:0; font-size:1.5rem;">ã©ã®å­¦å¹´ã‚’ã‚„ã‚‹ï¼Ÿ</h2>
        <p style="margin:5px 0 15px; color:#777; font-size:0.85rem;">å…¨1026æ–‡å­— æ›¸ãå–ã‚Šç·´ç¿’å¯¾å¿œï¼</p>
      </div>

      <div class="grade-grid">
        <div class="grade-card" onclick="startApp(1)" style="border-color: var(--g1-color);">
            <div class="card-icon">ğŸ£</div><div class="card-title">1ã­ã‚“ã›ã„</div>
        </div>
        <div class="grade-card" onclick="startApp(2)" style="border-color: var(--g2-color);">
            <div class="card-icon">ğŸ¹</div><div class="card-title">2ã­ã‚“ã›ã„</div>
        </div>
        <div class="grade-card" onclick="startApp(3)" style="border-color: var(--g3-color);">
            <div class="card-icon">ğŸ¬</div><div class="card-title">3ã­ã‚“ã›ã„</div>
        </div>
        <div class="grade-card" onclick="startApp(4)" style="border-color: var(--g4-color);">
            <div class="card-icon">ğŸ¦</div><div class="card-title">4ã­ã‚“ã›ã„</div>
        </div>
        <div class="grade-card" onclick="startApp(5)" style="border-color: var(--g5-color);">
            <div class="card-icon">ğŸš€</div><div class="card-title">5ã­ã‚“ã›ã„</div>
        </div>
        <div class="grade-card" onclick="startApp(6)" style="border-color: var(--g6-color);">
            <div class="card-icon">ğŸ‘‘</div><div class="card-title">6ã­ã‚“ã›ã„</div>
        </div>
      </div>

      <div class="footer-content">
          <div class="footer-note">
            <strong>âš ï¸ ä¿è­·è€…ãƒ»å…ˆç”Ÿæ–¹ã¸</strong><br>
            æœ¬ã‚¢ãƒ—ãƒªã¯ã€å­¦ç¿’æ”¯æ´ã®ãŸã‚ã«ä½œæˆã•ã‚ŒãŸWebã‚¢ãƒ—ãƒªã§ã™ã€‚<br>
            <div style="margin-top: 10px; padding: 8px; background-color: #fff; border-radius:4px; border:1px solid #ddd;">
                <strong>ã€åˆ¤å®šã«é–¢ã™ã‚‹ã”æ³¨æ„ã€‘</strong><br>
                ãƒ»ãƒ‡ã‚¸ã‚¿ãƒ«ã®æ¨™æº–å­—ä½“ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€ä¸€éƒ¨ã®æ¼¢å­—ã§æ•™ç§‘æ›¸ã¨ç•°ãªã‚‹å½¢ï¼ˆç³¸ã¸ã‚“ã®ä¸‹ãŒã€Œä¸‰æœ¬ç‚¹ã€ã«ãªã‚‹ç­‰ï¼‰ãŒè¡¨ç¤ºãƒ»åˆ¤å®šã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
                ãƒ»<strong>å­¦æ ¡ã§ç¿’ã£ãŸæ›¸ãæ–¹ãŒæœ€ã‚‚æ­£ã—ã„åŸºæº–ã§ã™ã€‚</strong>ã‚¢ãƒ—ãƒªã®åˆ¤å®šã¯ã‚ãã¾ã§ç›®å®‰ã¨ã—ã¦ã”æ´»ç”¨ãã ã•ã„ã€‚
            </div>
           </div>

           <div class="app-credits-container">
            <div class="credit-warning-box">
                <strong>âš ï¸ ç­†é †ï¼ˆæ›¸ãé †ï¼‰ã«ã¤ã„ã¦</strong><br>
                æœ¬ã‚¢ãƒ—ãƒªã§ã¯æ—¥æœ¬ã®æ¨™æº–çš„ãªç­†é †ã‚’å„ªå…ˆã—ã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ã®éƒ½åˆä¸Šã€ä¸€éƒ¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                <strong>å­¦æ ¡ã®æ•™ç§‘æ›¸ã‚„å…ˆç”Ÿã®æŒ‡å°ã¨ç•°ãªã‚‹å ´åˆã¯ã€æ•™ç§‘æ›¸ã‚’æ­£è§£ã¨ã—ã¦ãã ã•ã„ã€‚</strong>
            </div>
        
            <h3 style="font-size:1rem; border-bottom:2px solid #eee; padding-bottom:5px;">ä½¿ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</h3>
            <ul class="credit-list">
                <li class="credit-item">
                    <div class="credit-name">1. æ—¥æœ¬èªæ¼¢å­—ãƒ‡ãƒ¼ã‚¿ (hanzi-writer-data-jp)</div>
                    <div class="credit-desc">
                        â€¢ Source: <a href="https://github.com/chanind/hanzi-writer-data-jp" target="_blank">GitHub</a><br>
                        â€¢ Derived from <strong>AnimCJK</strong> (Copyright 2016-2019 FranÃ§ois Mizessyn)<br>
                        â€¢ Original Glyph: <strong>Arphic Public License</strong> (Copyright 1999 Arphic Technology Co., Ltd.)
                        <details class="license-details">
                        <summary class="license-summary">â–¶ Arphic Public License å…¨æ–‡</summary>
                        <div class="license-full-text">ARPHIC PUBLIC LICENSE
Copyright (C) 1999 Arphic Technology Co., Ltd.
11Fl. No.168, Yung Chi Rd., Taipei, 110 Taiwan
All rights reserved except as specified below.

Everyone is permitted to copy and distribute verbatim copies of this license document, but changing it is forbidden.

(è©³ç´°ã¯çœç•¥ã•ã‚Œã¦ã„ã¾ã™ãŒã€å…ƒã®ã‚³ãƒ¼ãƒ‰ã«ã‚ã‚‹å…¨æ–‡ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã¿ãªã—ã¦é‹ç”¨ã—ã¦ãã ã•ã„)
                        </div>
                        </details>
                    </div>
                </li>
                <li class="credit-item">
                    <div class="credit-name">2. è¡¨ç¤ºãƒ©ã‚¤ãƒ–ãƒ©ãƒª</div>
                    <div class="credit-desc">
                        â€¢ <strong>Hanzi Writer</strong>: <a href="https://chanind.github.io/hanzi-writer/" target="_blank">Official Site</a>
                    </div>
                </li>
            </ul>
           </div>
      </div>
      </div>

  <div id="app-screen">
      <div id="app-header">
          <button class="back-btn" onclick="closeApp()">ğŸ  ã‚‚ã©ã‚‹</button>
          <span style="font-weight:bold;" id="app-grade-title">1ã­ã‚“ã›ã„</span>
          <div style="font-size:0.8rem;">Lv.<span class="display-lvl">0</span></div>
      </div>
      
      <div id="canvas-area">
          <div id="drawing-board"></div>
      </div>

      <div class="controls">
          <div id="message-area"></div>
          <div class="status-panel">
              <span id="current-kanji-display">ä¸€ (ã„ã¡)</span>
          </div>
          <div class="char-nav">
              <button class="nav-btn" onclick="prevChar()">â—€</button>
              <button class="nav-btn" onclick="retryChar()">â†º</button>
              <button class="nav-btn" onclick="nextChar()">â–¶</button>
          </div>
      </div>
  </div>

  <div id="levelup-popup">
      <div style="font-size:3rem;">âœ¨</div>
      <div style="font-weight:bold; margin-top:10px;">ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</div>
      <div id="levelup-msg" style="margin-top:5px; font-size:0.9rem;"></div>
  </div>

  <script>
    // --- 1. ãƒ‡ãƒ¼ã‚¿å®šç¾© (åœ§ç¸®å½¢å¼) ---
    // ã“ã“ã«å¿…è¦ãªæ¼¢å­—ã‚’è¿½åŠ ãƒ»å¤‰æ›´ã—ã¦ãã ã•ã„
    const RAW_DATA = `
1|ä¸€:ã„ã¡|å³:ã¿ã|é›¨:ã‚ã‚|å††:ãˆã‚“|ç‹:ãŠã†|éŸ³:ãŠã¨|ä¸‹:ã—ãŸ|ç«:ã²|èŠ±:ã¯ãª|è²:ã‹ã„|å­¦:ãŒã|æ°—:ã|ä¹:ãã‚…ã†|ä¼‘:ã‚„ã™|ç‰:ãŸã¾|é‡‘:ãã‚“|ç©º:ãã‚‰|æœˆ:ã¤ã|çŠ¬:ã„ã¬|è¦‹:ã¿|äº”:ã”|å£:ãã¡|æ ¡:ã“ã†|å·¦:ã²ã ã‚Š|ä¸‰:ã•ã‚“|å±±:ã‚„ã¾|å­:ã“|å››:ã‚ˆã‚“|ç³¸:ã„ã¨|å­—:ã˜|è€³:ã¿ã¿|ä¸ƒ:ãªãª|è»Š:ãã‚‹ã¾|æ‰‹:ã¦|å:ã˜ã‚…ã†|å‡º:ã§|å¥³:ãŠã‚“ãª|å°:ã¡ã„|ä¸Š:ã†ãˆ|æ£®:ã‚‚ã‚Š|äºº:ã²ã¨|æ°´:ã¿ãš|æ­£:ãŸã |ç”Ÿ:ã„|é’:ã‚ãŠ|å¤•:ã‚†ã†|çŸ³:ã„ã—|èµ¤:ã‚ã‹|åƒ:ã›ã‚“|å·:ã‹ã‚|å…ˆ:ã•ã|æ—©:ã¯ã‚„|è‰:ãã•|è¶³:ã‚ã—|æ‘:ã‚€ã‚‰|å¤§:ãŠãŠ|ç”·:ãŠã¨ã“|ç«¹:ãŸã‘|ä¸­:ãªã‹|è™«:ã‚€ã—|ç”º:ã¾ã¡|å¤©:ã¦ã‚“|ç”°:ãŸ|åœŸ:ã¤ã¡|äºŒ:ã«|æ—¥:ã²|å…¥:ã¯ã„|å¹´:ã¨ã—|ç™½:ã—ã‚|å…«:ã¯ã¡|ç™¾:ã²ã‚ƒã|æ–‡:ã¶ã‚“|æœ¨:ã|æœ¬:ã»ã‚“|å:ãª|ç›®:ã‚|ç«‹:ãŸ|åŠ›:ã¡ã‹ã‚‰|æ—:ã¯ã‚„ã—|å…­:ã‚ã
2|å¼•:ã²|ç¾½:ã¯ã­|é›²:ãã‚‚|åœ’:ãˆã‚“|é :ã¨ãŠ|ä½•:ãªã«|ç§‘:ã‹|å¤:ãªã¤|å®¶:ã„ãˆ|æ­Œ:ã†ãŸ|ç”»:ãŒ|å›:ã¾ã‚|ä¼š:ã‚|æµ·:ã†ã¿|çµµ:ãˆ|å¤–:ãã¨|è§’:ã‹ã©|æ¥½:ãŸã®|æ´»:ã‹ã¤|é–“:ã‚ã„ã 
    `; 
    // â€»å®¹é‡ã®éƒ½åˆã§ä¸€éƒ¨çœç•¥ã—ã¦ã„ã¾ã™ã€‚å…ƒã®é•·ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«å…¥ã‚Œã‚Œã°å…¨æ¼¢å­—å¯¾å¿œã—ã¾ã™ã€‚

    let kanjiList = [];
    let currentGrade = 1;
    let currentIndex = 0;
    let writer = null;
    let audioCtx = null;

    // --- 2. ãƒ‡ãƒ¼ã‚¿å±•é–‹ ---
    function parseData() {
        kanjiList = [];
        RAW_DATA.trim().split('\n').forEach(line => {
            if(!line) return;
            const parts = line.split('|');
            const grade = parseInt(parts[0]);
            for(let i=1; i<parts.length; i++) {
                const [char, read] = parts[i].split(':');
                kanjiList.push({ grade, char, read });
            }
        });
    }

    // --- 3. XPã‚·ã‚¹ãƒ†ãƒ  ---
    const STORAGE_KEY = 'kanjiMaster_Full_v1';
    let userStats = { xp: 0, level: 0, charIdx: 0 }; // charIdxã¯ã‚³ãƒ¼ã‚¹é€²åŒ–ç”¨

    const CHARS = ["ğŸ¥š","ğŸ£","ğŸ¥","ğŸ¦…","ğŸ¦‰","ğŸ‰","ğŸ‘‘","ğŸŒŸ","ğŸŒŒ","ğŸª"]; // é€²åŒ–ã‚­ãƒ£ãƒ©

    function loadStats() {
        const d = localStorage.getItem(STORAGE_KEY);
        if(d) userStats = JSON.parse(d);
        updateXPDisplay();
    }
    function saveStats() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(userStats));
        updateXPDisplay();
    }
    function updateXPDisplay() {
        const level = Math.floor(userStats.xp / 10);
        const nextXp = 10 - (userStats.xp % 10);
        const charIcon = CHARS[Math.min(level, CHARS.length-1)];
        
        document.getElementById('current-lvl').textContent = userStats.xp; // ç°¡æ˜“è¡¨ç¤º: XPãã®ã‚‚ã®ã‚’Lvã¨ã™ã‚‹
        document.getElementById('next-xp').textContent = nextXp;
        document.getElementById('current-char').textContent = charIcon;
        document.querySelectorAll('.display-lvl').forEach(el => el.textContent = userStats.xp);
        
        const percent = ((userStats.xp % 10) / 10) * 100;
        document.getElementById('xp-fill').style.width = percent + '%';
    }
    function addXP() {
        userStats.xp++;
        saveStats();
        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡º
        if (userStats.xp % 10 === 0) {
            const popup = document.getElementById('levelup-popup');
            document.getElementById('levelup-msg').textContent = "æ–°ã—ã„ã‚­ãƒ£ãƒ©ã«é€²åŒ–ã—ãŸã‚ˆï¼";
            popup.classList.add('show');
            playSound('win');
            setTimeout(() => popup.classList.remove('show'), 3000);
        } else {
            playSound('correct');
        }
    }
    function resetData() {
        if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    // --- 4. éŸ³å£°åˆæˆ (mp3ãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦) ---
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    function playSound(type) {
        if (!audioCtx) initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'correct') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        } else if (type === 'win') {
            osc.type = 'triangle';
            // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬é¢¨
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.setValueAtTime(500, audioCtx.currentTime + 0.2);
            osc.frequency.setValueAtTime(600, audioCtx.currentTime + 0.4);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1);
            osc.start(); osc.stop(audioCtx.currentTime + 1);
        }
    }

    // --- 5. ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯ ---
    function startApp(grade) {
        initAudio();
        document.getElementById('portal-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'flex';
        
        currentGrade = grade;
        document.getElementById('app-grade-title').textContent = grade + "ã­ã‚“ã›ã„";
        
        // ãã®å­¦å¹´ã®æœ€åˆã®æ¼¢å­—ã‚’æ¢ã™
        const firstIdx = kanjiList.findIndex(k => k.grade === grade);
        currentIndex = (firstIdx !== -1) ? firstIdx : 0;
        
        loadKanji();
    }

    function closeApp() {
        document.getElementById('app-screen').style.display = 'none';
        document.getElementById('portal-screen').style.display = 'flex';
        if(writer) { writer.hideOutline(); } // ãƒªã‚»ãƒƒãƒˆ
    }

    function loadKanji() {
        const data = kanjiList[currentIndex];
        document.getElementById('current-kanji-display').textContent = `${data.char} (${data.read})`;
        document.getElementById('message-area').textContent = "";
        
        // æç”»ã‚¨ãƒªã‚¢ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('drawing-board').innerHTML = "";
        
        // Hanzi Writer åˆæœŸåŒ–
        writer = HanziWriter.create('drawing-board', data.char, {
            width: 300, height: 300, padding: 20,
            strokeColor: '#333',
            drawingWidth: 20, // å¤ªã•
            showOutline: true,
            outlineColor: '#ddd',
            quiz: {
                onMistake: function(strokeData) {
                    document.getElementById('message-area').textContent = "ãŠã—ã„ï¼";
                    // playSound('mistake'); // é–“é•ã„éŸ³ã¯ãªã—ã§ã‚‚OK
                },
                onCorrectStroke: function(strokeData) {
                    document.getElementById('message-area').textContent = "ã†ã¾ã„ï¼";
                },
                onComplete: function(summaryData) {
                    document.getElementById('message-area').textContent = "ã‚„ã£ãŸã­ï¼";
                    addXP();
                    setTimeout(nextChar, 1000);
                }
            }
        });
        writer.quiz();
    }

    function nextChar() {
        // åŒã˜å­¦å¹´ã®ç¯„å›²å†…ã§æ¬¡ã¸
        let nextIdx = currentIndex + 1;
        if (nextIdx < kanjiList.length && kanjiList[nextIdx].grade === currentGrade) {
            currentIndex = nextIdx;
            loadKanji();
        } else {
            alert("ã“ã®å­¦å¹´ã®æ¼¢å­—ã¯ã“ã‚Œã§ãŠã—ã¾ã„ï¼ã™ã”ã„ï¼");
            closeApp();
        }
    }

    function prevChar() {
        let prevIdx = currentIndex - 1;
        if (prevIdx >= 0 && kanjiList[prevIdx].grade === currentGrade) {
            currentIndex = prevIdx;
            loadKanji();
        }
    }

    function retryChar() {
        loadKanji();
    }

    // é–‹å§‹å‡¦ç†
    parseData();
    loadStats();

  </script>
 </body>
</html>
