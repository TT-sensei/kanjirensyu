<!doctype html>
<html lang="ja">
 <head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å°å­¦æ ¡ã‹ã‚“ã˜ãƒã‚¹ã‚¿ãƒ¼ çµ±åˆãƒãƒ¼ã‚¿ãƒ«</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>

  <style>
        /* =========================================
           åŸºæœ¬è¨­å®šãƒ»ãƒãƒ¼ã‚¿ãƒ«ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ«
           ========================================= */
        body { box-sizing: border-box; }

        :root {
            --bg-color: #F4F7F6;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.08);
            --g1-color: #FF8A65; --g2-color: #FFD54F; --g3-color: #4FC3F7;
            --g4-color: #81C784; --g5-color: #BA68C8; --g6-color: #7986CB;
        }

        body {
            font-family: 'Mochiy Pop One', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; color: #37474F;
            min-height: 100vh; overflow-y: auto; display: flex; flex-direction: column;
        }

        /* --- XPãƒãƒ¼ (ä¸Šéƒ¨) --- */
        #xp-bar-container {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 200; 
            height: 110px;
            flex-shrink: 0;
            border-bottom: 3px solid #4FC3F7;
        }
        .xp-info { display: flex; align-items: center; gap: 20px; flex-grow: 1; position: relative; }
        
        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚ªãƒ¼ãƒ©æ¼”å‡º */
        .char-wrapper {
            position: relative;
            width: 80px; height: 80px;
            display: flex; align-items: center; justify-content: center;
            margin-left: 10px;
        }
        .char-icon { 
            font-size: 4.2rem;
            cursor: pointer; transition: transform 0.2s;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
            z-index: 2;
        }
        .char-icon:hover { transform: scale(1.1); }
        .char-icon:active { transform: scale(0.95); }

        /* ã‚ªãƒ¼ãƒ©å®šç¾© */
        .aura-bg {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            z-index: 1; pointer-events: none;
        }
        /* Lv1: é’ã„å…‰ */
        .aura-lv1 {
            width: 90px; height: 90px;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.6);
            border: 2px solid rgba(33, 150, 243, 0.3);
            animation: pulse-blue 2s infinite;
        }
        /* Lv2: é‡‘è‰²ã®å›è»¢ã‚ªãƒ¼ãƒ© */
        .aura-lv2 {
            width: 100px; height: 100px;
            background: conic-gradient(from 0deg, transparent, #FFD700, transparent);
            animation: spin-aura 3s linear infinite;
            filter: blur(5px);
            opacity: 0.7;
        }
        /* Lv3: è™¹è‰²ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚ªãƒ¼ãƒ© */
        .aura-lv3 {
            width: 110px; height: 110px;
            background: conic-gradient(#ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            animation: spin-aura 1.5s linear infinite;
            filter: blur(8px);
            opacity: 0.8;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
        }

        @keyframes pulse-blue { 0% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.9); } 50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.1); } 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.9); } }
        @keyframes spin-aura { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        .xp-stats { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; margin-left: 15px; }
        .xp-header { display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap;}
        .xp-text { font-size: 1.1rem; color: #222; font-weight: 800; }
        
        .xp-desc { 
            font-size: 0.75rem; color: #4FC3F7; font-weight: 700; 
            background: #E1F5FE; padding: 3px 10px; border-radius: 12px;
        }
        
        .xp-small { font-size: 0.85rem; color: #666; font-weight: 600; text-align: right; margin-right: 15px;}
        
        .progress-track {
            height: 18px; background: #ddd; border-radius: 9px;
            margin: 5px 15px 0 0; overflow: hidden; position: relative; box-shadow: inset 0 2px 5px rgba(0,0,0,0.15);
            width: 95%;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #4FC3F7, #29B6F6);
            width: 0%; transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 8px;
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.8);
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ & æ¤œç´¢ --- */
        header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px); 
            padding: 10px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            z-index: 100;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            height: 60px; 
            flex-shrink: 0;
        }
        .logo { font-size: 1.3rem; display: flex; align-items: center; gap: 8px; color: #2c3e50; font-weight: 700; }
        .search-container { position: relative; width: 100%; max-width: 420px; margin: 0 15px; }
        #search-input {
            width: 100%; padding: 10px 18px; border-radius: 30px;
            border: 2px solid #ddd; background: #f5f5f5;
            font-size: 0.95rem; font-family: inherit; outline: none; font-weight: 600;
        }
        #search-input:focus { background: #fff; border-color: #4FC3F7; }
        #search-results {
            position: absolute; top: 120%; left: 0; width: 100%;
            background: white; border-radius: 15px;
            box-shadow: 0 10px 35px rgba(0,0,0,0.2);
            max-height: 60vh; overflow-y: auto; display: none; padding: 12px; z-index: 200;
        }
        .result-card {
            display: flex; align-items: center; justify-content: space-between;
            padding: 13px 16px; margin-bottom: 10px; border-radius: 12px; cursor: pointer;
            border: 2px solid transparent; background: #f8f8f8;
        }
        .result-card:hover { background-color: #e8f4ff; border-color: #4FC3F7; }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ --- */
        #home-screen {
            flex-grow: 1; overflow-y: auto; padding: 25px;
            display: flex; flex-direction: column; align-items: center;
        }
        .hero-text { text-align: center; margin: 15px 0 25px; }
        .hero-title { font-size: 1.7rem; margin-bottom: 8px; color: #1a1a1a; font-weight: 800; }
        .grade-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(135px, 1fr));
            gap: 18px; width: 100%; max-width: 920px; padding-bottom: 25px;
        }
        @media (min-width: 600px) { .grade-grid { grid-template-columns: repeat(3, 1fr); gap: 22px; } }

        .grade-card {
            background: white; border-radius: 22px; padding: 18px;
            text-align: center; cursor: pointer; box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            transition: all 0.3s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 150px; border: 2px solid transparent;
        }
        .grade-card:hover { transform: translateY(-8px); box-shadow: 0 15px 40px rgba(0,0,0,0.18); }
        .card-icon { font-size: 3.5rem; margin-bottom: 10px; z-index: 2; transition: transform 0.3s; }
        .grade-card:hover .card-icon { transform: scale(1.2) rotate(5deg); }
        .card-title { font-size: 1.15rem; font-weight: 800; color: #333; z-index: 2; }
        .decoration-circle {
            position: absolute; width: 110px; height: 110px; border-radius: 50%;
            opacity: 0.12; z-index: 1; top: -35px; right: -35px;
        }

        /* --- ãƒ•ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ --- */
        .footer-note {
            width: 100%; max-width: 800px; margin-top: 25px; padding: 18px; 
            background-color: #E8F4FF; border-radius: 12px; font-size: 0.75rem; 
            color: #446688; line-height: 1.7; border-left: 4px solid #4FC3F7;
        }
        .settings-area {
            width: 100%; max-width: 850px; margin: 30px 0 80px;
            display: flex; justify-content: flex-end;
        }
        #reset-btn {
            background: #FFEBEE; border: 1px solid #FFCDD2; color: #D32F2F;
            padding: 8px 15px; border-radius: 20px; cursor: pointer;
            font-size: 0.8rem; font-weight: 700; transition: all 0.2s;
        }
        #reset-btn:hover { background: #FFCDD2; }

        #change-course-btn {
            position: fixed; bottom: 20px; right: 20px;
            background: linear-gradient(135deg, #fff 0%, #f0f5ff 100%);
            border: 2px solid #4FC3F7; border-radius: 30px;
            padding: 12px 18px; font-family: inherit; font-size: 0.9rem; color: #333;
            cursor: pointer; box-shadow: 0 6px 18px rgba(79, 195, 247, 0.25); z-index: 300;
            display: flex; align-items: center; gap: 7px; font-weight: 700;
            transition: all 0.3s;
        }
        #change-course-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 28px rgba(79, 195, 247, 0.4); }

        /* --- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç³» --- */
        .xp-gain-effect {
            position: fixed; pointer-events: none; font-weight: 800; color: #29B6F6;
            font-size: 1.5rem; animation: xp-gain 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            text-shadow: 0 0 15px rgba(79, 195, 247, 0.8); z-index: 999;
        }
        @keyframes xp-gain { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.4); } }

        #levelup-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #FFD54F 0%, #FFCA28 100%);
            padding: 35px 50px; border-radius: 25px; text-align: center;
            box-shadow: 0 15px 50px rgba(0,0,0,0.35); z-index: 1000; 
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 4px solid #fff;
        }
        #levelup-popup.show { transform: translate(-50%, -50%) scale(1); }

        /* --- ã‚³ãƒ¼ã‚¹é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« --- */
        #course-modal, #reset-confirm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center;
            z-index: 1100; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 25px; width: 90%; max-width: 420px; text-align: center;
        }
        .course-option {
            display: flex; align-items: center; justify-content: space-between;
            background: #f5f5f5; padding: 16px; margin-bottom: 12px;
            border-radius: 14px; cursor: pointer; transition: all 0.3s;
        }
        .course-option.active { 
            border-color: #4FC3F7; background: linear-gradient(135deg, #E1F5FE, #B3E5FC);
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.25);
        }
        .co-icon { font-size: 2rem; }
        .co-name { font-weight: 800; font-size: 1rem; flex-grow: 1; margin-left: 14px; text-align: left; }

        /* =========================================
           ã‚¢ãƒ—ãƒªç”»é¢ (App) ã‚¹ã‚¿ã‚¤ãƒ«
           ========================================= */
        body.app-mode {
            background-color: #FFF3E0 !important;
            overflow-x: hidden; touch-action: manipulation; user-select: none;
        }
        #app-view { display: none; width: 100%; min-height: 100vh; }
        .screen {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; min-height: 100vh; padding: 20px; box-sizing: border-box;
            opacity: 0; transition: opacity 0.3s;
        }
        .screen.active { display: flex; opacity: 1; }

        #title-screen-app { 
            background: linear-gradient(135deg, #FFD54F 0%, #FFB74D 50%, #FFAB91 100%);
        }
        .game-title {
            font-size: 3rem; color: #FFF; text-shadow: 3px 3px 0 #BF360C;
            text-align: center; margin-bottom: 40px; animation: titleBounce 2s infinite;
        }
        @keyframes titleBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .mode-btn {
            width: 280px; font-size: 1.5rem; padding: 15px 0; border-radius: 50px; border: none; cursor: pointer;
            margin: 10px 0; color: white; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.2); font-family: inherit; transition: all 0.2s ease;
        }
        .mode-btn:active { transform: scale(0.95) translateY(2px); box-shadow: 0 3px 0 rgba(0,0,0,0.2); }
        .btn-practice { background: linear-gradient(135deg, #66BB6A 0%, #4CAF50 100%); }
        .btn-test { background: linear-gradient(135deg, #EF5350 0%, #F44336 100%); }
        .btn-exit { background: linear-gradient(135deg, #78909C 0%, #546E7A 100%); margin-top: 20px; font-size: 1rem; width: 150px; }

        #list-screen { justify-content: flex-start; padding-top: 20px; background: #FFF3E0; }
        .header-info {
            background: white; padding: 15px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
            display: flex; flex-direction: column; align-items: center; width: 90%; max-width: 600px;
        }
        .kanji-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            gap: 12px; width: 100%; max-width: 800px; padding-bottom: 50px;
        }
        .kanji-card {
            background: white; aspect-ratio: 1; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; cursor: pointer; position: relative;
            box-shadow: 0 4px 0 #D7CCC8; border: 2px solid #FFE0B2;
        }
        .mark { position: absolute; top: -8px; right: -8px; font-size: 1.2rem; display: none; }
        .cleared-practice .star-mark { display: block; }
        .cleared-test .crown-mark { display: block; }
        
        .cleared-practice { background: #F1F8E9; border-color: #8BC34A; box-shadow: 0 4px 0 #558B2F; }
        .cleared-test { background: #FFEBEE; border-color: #EF5350; box-shadow: 0 4px 0 #C62828; }

        #practice-screen { background: #E0F7FA; position: relative; }
        #practice-screen.test-bg { background: #FFEBEE; }
        .canvas-container {
            background: white; padding: 15px; border-radius: 20px;
            box-shadow: 0 8px 0 #B0BEC5; margin-bottom: 20px; position: relative;
        }
        #character-target-div { width: 300px; height: 300px; touch-action: none; }
        
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 200;
        }
        #result-overlay.active { display: flex; }
        .result-btn {
            width: 240px; padding: 15px; margin: 10px 0; border: none;
            border-radius: 50px; font-size: 1.3rem; color: white;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2); font-family: inherit; cursor: pointer;
        }
        .btn-next { background: #4CAF50; } .btn-retry { background: #FF9800; } .btn-home { background: #607D8B; }

        @media (max-width: 480px) {
            .hero-title { font-size: 1.4rem; }
            #xp-bar-container { height: 100px; }
            .char-icon { font-size: 3.5rem; }
        }
    </style>
 </head>
 <body>
  
  <div id="portal-view">
      <div id="xp-bar-container">
       <div class="xp-info">
        <div class="char-wrapper">
            <div id="aura-effect" class="aura-bg"></div>
            <div class="char-icon" id="current-char" onclick="openCourseModal()" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ¼ã‚¹å¤‰æ›´ï¼">ğŸ¥š</div>
        </div>
        <div class="xp-stats">
         <div class="xp-header">
          <div class="xp-text">Lv.<span id="current-lvl">0</span></div>
          <div class="xp-desc">ã‹ã‚“ã˜ã‚’ ãŠã¼ãˆã¦ ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ï¼</div>
         </div>
         <div class="progress-track">
          <div class="progress-fill" id="xp-fill"></div>
         </div>
         <div class="xp-small">ã‚ã¨<span id="next-xp">5</span>å€‹ã§ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ— / ã¤ãã®ã‚ªãƒ¼ãƒ©ã¾ã§ã‚ã¨<span id="next-aura">10</span>å† </div>
        </div>
       </div>
      </div>
      
      <header>
       <div class="logo"><span>ğŸ«</span> æ¼¢å­—ãƒã‚¹ã‚¿ãƒ¼</div>
       <div class="search-container">
        <input type="text" id="search-input" placeholder="ã‹ã‚“ã˜ãƒ»ã‚ˆã¿ï¼ˆä¾‹ï¼šã‹ãŸï¼‰" autocomplete="off">
        <div id="search-results"></div>
       </div>
      </header>
      
      <div id="home-screen">
       <div class="hero-text">
        <div class="hero-title">ã©ã®å­¦å¹´ã‚’ã¯ã˜ã‚ã‚‹ï¼Ÿ</div>
        <div class="hero-subtitle">å…¨1026æ–‡å­— åéŒ²æ¸ˆã¿</div>
       </div>
       <div class="grade-grid">
        <div class="grade-card" onclick="launchApp(1)" style="border-bottom: 5px solid var(--g1-color);">
         <div class="decoration-circle" style="background: var(--g1-color);"></div>
         <div class="card-icon">ğŸ£</div>
         <div class="card-title">1ã­ã‚“ã›ã„</div>
        </div>
        <div class="grade-card" onclick="launchApp(2)" style="border-bottom: 5px solid var(--g2-color);">
         <div class="decoration-circle" style="background: var(--g2-color);"></div>
         <div class="card-icon">ğŸ¹</div>
         <div class="card-title">2ã­ã‚“ã›ã„</div>
        </div>
        <div class="grade-card" onclick="launchApp(3)" style="border-bottom: 5px solid var(--g3-color);">
         <div class="decoration-circle" style="background: var(--g3-color);"></div>
         <div class="card-icon">ğŸ¬</div>
         <div class="card-title">3ã­ã‚“ã›ã„</div>
        </div>
        <div class="grade-card" onclick="launchApp(4)" style="border-bottom: 5px solid var(--g4-color);">
         <div class="decoration-circle" style="background: var(--g4-color);"></div>
         <div class="card-icon">ğŸ¦</div>
         <div class="card-title">4ã­ã‚“ã›ã„</div>
        </div>
        <div class="grade-card" onclick="launchApp(5)" style="border-bottom: 5px solid var(--g5-color);">
         <div class="decoration-circle" style="background: var(--g5-color);"></div>
         <div class="card-icon">ğŸš€</div>
         <div class="card-title">5ã­ã‚“ã›ã„</div>
        </div>
        <div class="grade-card" onclick="launchApp(6)" style="border-bottom: 5px solid var(--g6-color);">
         <div class="decoration-circle" style="background: var(--g6-color);"></div>
         <div class="card-icon">ğŸ‘‘</div>
         <div class="card-title">6ã­ã‚“ã›ã„</div>
        </div>
       </div>
       
       <div class="footer-note">
        <strong>âš ï¸ ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦</strong><br>
        ã“ã®ã‚¢ãƒ—ãƒªã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸­ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚å±¥æ­´ã‚’æ¶ˆå»ã™ã‚‹ã¨å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã¦ã—ã¾ã†ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚
       </div>

       <div class="settings-area">
           <button id="reset-btn" onclick="showResetConfirm()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
       </div>
      </div>
      
      <button id="change-course-btn" onclick="openCourseModal()"><span>ğŸ®</span> ã‚³ãƒ¼ã‚¹ã‚’ã‹ãˆã‚‹</button>
      
      <div id="levelup-popup">
       <div class="levelup-emoji" id="levelup-emoji" style="font-size:3.5rem;">âœ¨</div>
       <div class="levelup-text" style="font-size:1.6rem; color:#fff; font-weight:800; text-shadow:0 4px 8px rgba(0,0,0,0.25);">ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</div>
       <div class="levelup-text" style="font-size: 1.2rem; opacity: 0.95;" id="levelup-char"></div>
      </div>

      <div id="course-modal" onclick="if(event.target.id==='course-modal') this.style.display='none'">
       <div class="modal-content">
        <div class="modal-title" style="font-size:1.4rem; font-weight:800; margin-bottom:20px;">ğŸ® ã‚³ãƒ¼ã‚¹ã‚’ãˆã‚‰ã‚“ã§ã­</div>
        <div id="course-list"></div>
        <button onclick="document.getElementById('course-modal').style.display='none'" style="margin-top:15px; padding:10px 30px; border-radius:20px; border:none; background:#4FC3F7; color:white; font-weight:bold;">ã¨ã˜ã‚‹</button>
       </div>
      </div>

      <div id="reset-confirm-overlay">
       <div class="modal-content">
        <div style="font-size:1.3rem; margin-bottom:15px; color:#D32F2F; font-weight:800;">âš ï¸ ã»ã‚“ã¨ã†ã« ã‘ã—ã¾ã™ã‹ï¼Ÿ</div>
        <div style="margin-bottom:20px;">ã™ã¹ã¦ã®å­¦å¹´ã®è¨˜éŒ²ãŒæ¶ˆãˆã¾ã™ã€‚<br>ã‚‚ã¨ã«ã¯ ã‚‚ã©ã›ã¾ã›ã‚“ã€‚</div>
        <button onclick="document.getElementById('reset-confirm-overlay').style.display='none'" style="background:#f0f0f0; padding:10px 20px; border-radius:20px; border:none; margin-right:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="confirmReset()" style="background:#FF6B6B; color:white; padding:10px 20px; border-radius:20px; border:none;">ãƒ‡ãƒ¼ã‚¿ã‚’ã‘ã™</button>
       </div>
      </div>
  </div>

  <div id="app-view">
      <div id="title-screen-app" class="screen active">
       <div class="game-title">ã‹ã‚“ã˜ãƒã‚¹ã‚¿ãƒ¼</div>
       <button class="mode-btn btn-practice" onclick="selectMode('practice')"><span>â­</span> ã‚Œã‚“ã—ã‚…ã†</button> 
       <button class="mode-btn btn-test" onclick="selectMode('test')"><span>ğŸ†</span> ãƒ†ã‚¹ãƒˆ</button>
       <button class="mode-btn btn-exit" onclick="exitApp()">ãƒãƒ¼ã‚¿ãƒ«ã¸ã‚‚ã©ã‚‹</button>
      </div>
      
      <div id="list-screen" class="screen">
       <div class="header-info">
        <div id="mode-display" style="font-size:1rem; padding:5px 15px; border-radius:20px; color:white; margin-bottom:5px; font-weight:bold;"></div>
        <div>ã‚ã¤ã‚ãŸæ•°ï¼š<span id="star-counter" style="font-weight:bold;">0</span> / <span id="max-count">80</span></div>
        <input type="text" id="app-search-box" placeholder="ã‘ã‚“ã•ãï¼ˆã‚ˆã¿ãƒ»ã‹ã‚“ã˜ï¼‰" oninput="filterAppList()" style="width:100%; padding:10px; margin-top:10px; border:2px solid #FFCC80; border-radius:10px;">
        <button class="nav-btn" onclick="showAppScreen('title-screen-app')" style="margin-top:10px; background:#607D8B; color:white; border:none; padding:8px 16px; border-radius:20px;">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
       </div>
       <div class="kanji-grid" id="kanji-grid"></div>
      </div>
      
      <div id="practice-screen" class="screen">
       <div style="width:100%; max-width:500px; display:flex; justify-content:space-between; margin-bottom:20px;">
        <button class="nav-btn" onclick="showAppScreen('list-screen')" style="background:#607D8B; color:white; border:none; padding:8px 16px; border-radius:20px;">ã‚‚ã©ã‚‹</button>
        <div id="current-reading" style="font-size:1.8rem; color:#006064; font-weight:bold;">ã‚ˆã¿</div>
        <div style="width:60px;"></div>
       </div>
       <div class="canvas-container">
        <div id="character-target-div"></div>
       </div>
       <div id="message-area" style="height:40px; font-size:1.2rem; font-weight:bold; text-align:center;">ãªãã£ã¦ã¿ã‚ˆã†ï¼</div>
       <div id="result-overlay">
        <div class="result-title" id="result-title-text" style="font-size:2.5rem; margin-bottom:20px;">ã§ããŸï¼</div>
        <button class="result-btn btn-next" onclick="goNext()">ã¤ãã¸ â–¶</button> 
        <button class="result-btn btn-retry" onclick="retry()">ã‚‚ã†ã„ã¡ã© â†º</button> 
        <button class="result-btn btn-home" onclick="showAppScreen('list-screen')">ãƒ›ãƒ¼ãƒ  ğŸ </button>
       </div>
       <button class="nav-btn" onclick="retry()" style="background:#FF7043; margin-top:10px; color:white; border:none; padding:8px 16px; border-radius:20px; z-index:10;">æ›¸ãç›´ã™</button>
      </div>
  </div>

  <script>
        // =========================================
        // 1. ãƒ‡ãƒ¼ã‚¿å®šç¾© & çµ±åˆç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
        // =========================================
        const STARS_PER_LEVEL = 5; // æ˜Ÿ5å€‹ã§1ãƒ¬ãƒ™ãƒ«
        const CROWNS_PER_AURA = 10; // ç‹å† 10å€‹ã§ã‚ªãƒ¼ãƒ©é€²åŒ–

        const COURSES = {
            A: { name: "å†’é™ºã‚³ãƒ¼ã‚¹", chars: ["ğŸ¥š", "ğŸ£", "ğŸ—¡ï¸", "ğŸ›¡ï¸", "ğŸ´", "ğŸ°", "ğŸ§š", "ğŸ‰", "âš”ï¸", "ğŸ‘‘", "ğŸŒŸ"] },
            B: { name: "è‡ªç„¶ã‚³ãƒ¼ã‚¹", chars: ["ğŸŒ±", "ğŸ’§", "ğŸŒ¿", "ğŸ€", "ğŸ„", "ğŸŒ·", "ğŸŒ»", "ğŸŒ³", "ğŸ", "ğŸ¥§", "ğŸŒˆ"] },
            C: { name: "ä¹—ç‰©ã‚³ãƒ¼ã‚¹", chars: ["ğŸš¶", "ğŸ›´", "ğŸš²", "ğŸ›µ", "ğŸš—", "ğŸšŒ", "ğŸš…", "ğŸš¢", "âœˆï¸", "ğŸš€", "ğŸ›¸"] },
            D: { name: "ã‚¢ã‚¤ãƒ‰ãƒ«",   chars: ["ğŸµ", "ğŸ©°", "ğŸ€", "ğŸ’„", "ğŸ‘—", "ğŸ¤", "ğŸ¸", "ğŸ¹", "ğŸ’ƒ", "ğŸ“¸", "ğŸ‘¸"] },
            E: { name: "å’Œé¢¨ãƒ»å¿è€…", chars: ["ğŸµ", "ğŸ™", "ğŸ¥‹", "ğŸ“œ", "ğŸ—¡ï¸", "ğŸ¥·", "ğŸ¯", "ğŸ‘º", "é¬¼", "ğŸŒ", "ğŸŒ¸"] }
        };

        const PORTAL_KEY = 'kanjiMaster_portal_v1';
        
        // å…¨å­¦å¹´ã®å­¦ç¿’çŠ¶æ³ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦åˆç®—ã™ã‚‹
        function getAllStats() {
            let totalStars = 0;
            let totalCrowns = 0;
            
            for (let g = 1; g <= 6; g++) {
                const practice = JSON.parse(localStorage.getItem(`kanjiMasterPractice_${g}`)) || {};
                const test = JSON.parse(localStorage.getItem(`kanjiMasterTest_${g}`)) || {};
                totalStars += Object.keys(practice).length;
                totalCrowns += Object.keys(test).length;
            }
            return { totalStars, totalCrowns };
        }

        // ãƒãƒ¼ã‚¿ãƒ«è¨­å®šã®å–å¾—ãƒ»ä¿å­˜
        function getPortalSettings() {
            const def = { currentCourse: "A" };
            try {
                const data = localStorage.getItem(PORTAL_KEY);
                return data ? { ...def, ...JSON.parse(data) } : def;
            } catch(e) { return def; }
        }
        function savePortalSettings(s) { localStorage.setItem(PORTAL_KEY, JSON.stringify(s)); }

        // --- UIæ›´æ–° ---
        function updatePortalUI() {
            const stats = getAllStats();
            const settings = getPortalSettings();
            
            // ãƒ¬ãƒ™ãƒ«è¨ˆç®—: æ˜Ÿ Ã· 5
            const level = Math.floor(stats.totalStars / STARS_PER_LEVEL);
            const nextLevelStars = (level + 1) * STARS_PER_LEVEL - stats.totalStars;
            
            // ã‚ªãƒ¼ãƒ©è¨ˆç®—: ç‹å†  Ã· 10 (æœ€å¤§Lv3)
            const auraLevel = Math.min(Math.floor(stats.totalCrowns / CROWNS_PER_AURA), 3);
            const nextAuraCrowns = (auraLevel >= 3) ? 0 : (CROWNS_PER_AURA * (auraLevel + 1)) - stats.totalCrowns;

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ±ºå®š (ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å¤‰åŒ–ã€æœ€å¤§å€¤ã§æ­¢ã‚ã‚‹)
            const courseData = COURSES[settings.currentCourse];
            const charIndex = Math.min(level, courseData.chars.length - 1);
            const char = courseData.chars[charIndex];

            // è¡¨ç¤ºæ›´æ–°
            document.getElementById('current-char').textContent = char;
            document.getElementById('current-lvl').textContent = level + " (æ˜Ÿ" + stats.totalStars + ")";
            document.getElementById('next-xp').textContent = nextLevelStars;
            
            // ã‚ªãƒ¼ãƒ©è¡¨ç¤º
            const auraEl = document.getElementById('aura-effect');
            auraEl.className = 'aura-bg'; // ãƒªã‚»ãƒƒãƒˆ
            if(auraLevel > 0) auraEl.classList.add(`aura-lv1`); // ãƒ™ãƒ¼ã‚¹
            if(auraLevel >= 2) auraEl.classList.remove('aura-lv1'), auraEl.classList.add('aura-lv2');
            if(auraLevel >= 3) auraEl.classList.remove('aura-lv2'), auraEl.classList.add('aura-lv3');
            
            document.getElementById('next-aura').textContent = (auraLevel >= 3) ? "MAX" : nextAuraCrowns;

            // ãƒãƒ¼ã®æ›´æ–°
            const fill = document.getElementById('xp-fill');
            const percent = ((STARS_PER_LEVEL - nextLevelStars) / STARS_PER_LEVEL) * 100;
            fill.style.width = percent + "%";
        }

        // ã‚³ãƒ¼ã‚¹å¤‰æ›´
        function openCourseModal() {
            const modal = document.getElementById('course-modal');
            const list = document.getElementById('course-list');
            const current = getPortalSettings().currentCourse;
            const stats = getAllStats();
            const level = Math.floor(stats.totalStars / STARS_PER_LEVEL);

            list.innerHTML = '';
            for (const [key, data] of Object.entries(COURSES)) {
                const charIndex = Math.min(level, data.chars.length - 1);
                const isActive = (key === current);
                
                const div = document.createElement('div');
                div.className = `course-option ${isActive ? 'active' : ''}`;
                div.onclick = () => {
                    const s = getPortalSettings();
                    s.currentCourse = key;
                    savePortalSettings(s);
                    updatePortalUI();
                    modal.style.display = 'none';
                    showXPGainEffect(window.innerWidth/2, window.innerHeight/2, "å¤‰èº«ï¼");
                };
                div.innerHTML = `
                    <div class="co-icon">${data.chars[charIndex]}</div>
                    <div class="co-name">${data.name}</div>
                    <div style="font-weight:bold; color:${isActive?'#4FC3F7':'#aaa'}">${isActive?'é¸æŠä¸­':'é¸ã¶'}</div>
                `;
                list.appendChild(div);
            }
            modal.style.display = 'flex';
        }

        function showXPGainEffect(x, y, text) {
            const effect = document.createElement('div');
            effect.className = 'xp-gain-effect';
            effect.textContent = text;
            effect.style.left = (x - 40) + 'px';
            effect.style.top = y + 'px';
            document.body.appendChild(effect);
            setTimeout(() => effect.remove(), 1200);
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        function showResetConfirm(){ document.getElementById('reset-confirm-overlay').style.display='flex'; }
        function confirmReset() {
            localStorage.clear();
            location.reload();
        }

        // =========================================
        // 2. æ¼¢å­—ãƒ‡ãƒ¼ã‚¿å®šç¾© (åœ§ç¸®ç‰ˆ)
        // =========================================
        const rawData = `
        1|ä¸€:ã„ã¡|å³:ã¿ã|é›¨:ã‚ã‚|å††:ãˆã‚“|ç‹:ãŠã†|éŸ³:ãŠã¨|ä¸‹:ã—ãŸ|ç«:ã²|èŠ±:ã¯ãª|è²:ã‹ã„|å­¦:ãŒã|æ°—:ã|ä¹:ãã‚…ã†|ä¼‘:ã‚„ã™|ç‰:ãŸã¾|é‡‘:ã‹ã­|ç©º:ãã‚‰|æœˆ:ã¤ã|çŠ¬:ã„ã¬|è¦‹:ã¿|äº”:ã”|å£:ãã¡|æ ¡:ã“ã†|å·¦:ã²ã ã‚Š|ä¸‰:ã•ã‚“|å±±:ã‚„ã¾|å­:ã“|å››:ã‚ˆã‚“|ç³¸:ã„ã¨|å­—:ã˜|è€³:ã¿ã¿|ä¸ƒ:ãªãª|è»Š:ãã‚‹ã¾|æ‰‹:ã¦|å:ã˜ã‚…ã†|å‡º:ã§|å¥³:ãŠã‚“ãª|å°:ã¡ã„|ä¸Š:ã†ãˆ|æ£®:ã‚‚ã‚Š|äºº:ã²ã¨|æ°´:ã¿ãš|æ­£:ãŸã |ç”Ÿ:ã„|é’:ã‚ãŠ|å¤•:ã‚†ã†|çŸ³:ã„ã—|èµ¤:ã‚ã‹|åƒ:ã›ã‚“|å·:ã‹ã‚|å…ˆ:ã•ã|æ—©:ã¯ã‚„|è‰:ãã•|è¶³:ã‚ã—|æ‘:ã‚€ã‚‰|å¤§:ãŠãŠ|ç”·:ãŠã¨ã“|ç«¹:ãŸã‘|ä¸­:ãªã‹|è™«:ã‚€ã—|ç”º:ã¾ã¡|å¤©:ã¦ã‚“|ç”°:ãŸ|åœŸ:ã¤ã¡|äºŒ:ã«|æ—¥:ã²|å…¥:ã¯ã„|å¹´:ã¨ã—|ç™½:ã—ã‚|å…«:ã¯ã¡|ç™¾:ã²ã‚ƒã|æ–‡:ã¶ã‚“|æœ¨:ã|æœ¬:ã»ã‚“|å:ãª|ç›®:ã‚|ç«‹:ãŸ|åŠ›:ã¡ã‹ã‚‰|æ—:ã¯ã‚„ã—|å…­:ã‚ã
        2|å¼•:ã²|ç¾½:ã¯ã­|é›²:ãã‚‚|åœ’:ãˆã‚“|é :ã¨ãŠ|ä½•:ãªã«|ç§‘:ã‹|å¤:ãªã¤|å®¶:ã„ãˆ|æ­Œ:ã†ãŸ|ç”»:ãŒ|å›:ã¾ã‚|ä¼š:ã‚|æµ·:ã†ã¿|çµµ:ãˆ|å¤–:ãã¨|è§’:ã‹ã©|æ¥½:ãŸã®|æ´»:ã‹ã¤|é–“:ã‚ã„ã |ä¸¸:ã¾ã‚‹|å²©:ã„ã‚|é¡”:ã‹ãŠ|æ±½:ã|è¨˜:ã|å¸°:ã‹ãˆ|å¼“:ã‚†ã¿|ç‰›:ã†ã—|é­š:ã•ã‹ãª|äº¬:ãã‚‡ã†|å¼·:ã¤ã‚ˆ|æ•™:ãŠã—|è¿‘:ã¡ã‹|å…„:ã‚ã«|å½¢:ã‹ãŸã¡|è¨ˆ:ã‘ã„|å…ƒ:ã‚‚ã¨|è¨€:ã„|åŸ:ã¯ã‚‰|æˆ¸:ã¨|å¤:ãµã‚‹|åˆ:ã”|å¾Œ:ã‚ã¨|èª:ã”|å·¥:ã“ã†|å…¬:ã“ã†|åºƒ:ã²ã‚|äº¤:ã¾ã˜|å…‰:ã²ã‹ã‚Š|è€ƒ:ã‹ã‚“ãŒ|è¡Œ:ã„|é«˜:ãŸã‹|é»„:ã|åˆ:ã‚|è°·:ãŸã«|å›½:ãã«|é»’:ãã‚|ä»Š:ã„ã¾|æ‰:ã•ã„|ç´°:ã»ã|ä½œ:ã¤ã|ç®—:ã•ã‚“|æ­¢:ã¨|å¸‚:ã—|çŸ¢:ã‚„|å§‰:ã‚ã­|æ€:ãŠã‚‚|ç´™:ã‹ã¿|å¯º:ã¦ã‚‰|è‡ª:ã˜|æ™‚:ã¨ã|å®¤:ã—ã¤|ç¤¾:ã—ã‚ƒ|å¼±:ã‚ˆã‚|é¦–:ãã³|ç§‹:ã‚ã|é€±:ã—ã‚…ã†|æ˜¥:ã¯ã‚‹|æ›¸:ã‹|å°‘:ã™ã“|å ´:ã°|è‰²:ã„ã‚|é£Ÿ:ãŸ|å¿ƒ:ã“ã“ã‚|æ–°:ã‚ãŸã‚‰|è¦ª:ãŠã‚„|å›³:ãš|æ•°:ã‹ãš|è¥¿:ã«ã—|å£°:ã“ãˆ|æ˜Ÿ:ã»ã—|æ™´:ã¯|åˆ‡:ã|é›ª:ã‚†ã|èˆ¹:ãµã­|ç·š:ã›ã‚“|å‰:ã¾ãˆ|çµ„:ãã¿|èµ°:ã¯ã—|å¤š:ãŠãŠ|å¤ª:ãµã¨|ä½“:ã‹ã‚‰ã |å°:ã ã„|åœ°:ã¡|æ± :ã„ã‘|çŸ¥:ã—|èŒ¶:ã¡ã‚ƒ|æ˜¼:ã²ã‚‹|é•·:ãªãŒ|é³¥:ã¨ã‚Š|æœ:ã‚ã•|ç›´:ãªãŠ|é€š:ã¨ãŠ|å¼Ÿ:ãŠã¨ã†ã¨|åº—:ã¿ã›|ç‚¹:ã¦ã‚“|é›»:ã§ã‚“|åˆ€:ã‹ãŸãª|å†¬:ãµã‚†|å½“:ã‚|æ±:ã²ãŒã—|ç­”:ã“ãŸ|é ­:ã‚ãŸã¾|åŒ:ãŠãª|é“:ã¿ã¡|èª­:ã‚ˆ|å†…:ã†ã¡|å—:ã¿ãªã¿|è‚‰:ã«ã|é¦¬:ã†ã¾|å£²:ã†|è²·:ã‹|éº¦:ã‚€ã|åŠ:ã¯ã‚“|ç•ª:ã°ã‚“|çˆ¶:ã¡ã¡|é¢¨:ã‹ãœ|åˆ†:ã¶ã‚“|è:ã|ç±³:ã“ã‚|æ­©:ã‚ã‚‹|æ¯:ã¯ã¯|æ–¹:ã»ã†|åŒ—:ããŸ|å¦¹:ã„ã‚‚ã†ã¨|æ¯:ã¾ã„|ä¸‡:ã¾ã‚“|æ˜:ã‚ã‹|é³´:ãª|æ¯›:ã‘|é–€:ã‚‚ã‚“|å¤œ:ã‚ˆã‚‹|é‡:ã®|å‹:ã¨ã‚‚|ç”¨:ã‚ˆã†|æ›œ:ã‚ˆã†|æ¥:ã|é‡Œ:ã•ã¨|ç†:ã‚Š|è©±:ã¯ãªã—
        3|æ‚ª:ã‚ã‚‹|å®‰:ã‚„ã™|æš—:ãã‚‰|åŒ»:ã„|å§”:ã„|æ„:ã„|è‚²:ãã |å“¡:ã„ã‚“|é™¢:ã„ã‚“|é£²:ã®|é‹:ã¯ã“|æ³³:ãŠã‚ˆ|é§…:ãˆã|å¤®:ãŠã†|æ¨ª:ã‚ˆã“|å±‹:ã‚„|æ¸©:ã‚ãŸãŸ|åŒ–:ã‹|è·:ã«|ç•Œ:ã‹ã„|é–‹:ã‚|éš:ã‹ã„|å¯’:ã•ã‚€|æ„Ÿ:ã‹ã‚“|æ¼¢:ã‹ã‚“|é¤¨:ã‹ã‚“|å²¸:ãã—|èµ·:ãŠ|æœŸ:ã|å®¢:ãã‚ƒã|ç©¶:ãã‚…ã†|æ€¥:ã„ã|ç´š:ãã‚…ã†|å®®:ã¿ã‚„|çƒ:ãŸã¾|å»:ã•|æ©‹:ã¯ã—|æ¥­:ãã‚‡ã†|æ›²:ã¾|å±€:ãã‚‡ã|éŠ€:ãã‚“|åŒº:ã|è‹¦:ãã‚‹|å…·:ã|å›:ãã¿|ä¿‚:ã‹ã‹ã‚Š|è»½:ã‹ã‚‹|è¡€:ã¡|æ±º:ã|ç ”:ã‘ã‚“|çœŒ:ã‘ã‚“|åº«:ã“|æ¹–:ã¿ãšã†ã¿|å‘:ã‚€|å¹¸:ã—ã‚ã‚|æ¸¯:ã¿ãªã¨|å·:ã”ã†|æ ¹:ã­|ç¥­:ã¾ã¤|çš¿:ã•ã‚‰|ä»•:ã—|æ­»:ã—|ä½¿:ã¤ã‹|å§‹:ã¯ã˜|æŒ‡:ã‚†ã³|æ­¯:ã¯|è©©:ã—|æ¬¡:ã¤ã|äº‹:ã“ã¨|æŒ:ã‚‚|å¼:ã—ã|å®Ÿ:ã¿|å†™:ã†ã¤|è€…:ã‚‚ã®|ä¸»:ãŠã‚‚|å®ˆ:ã¾ã‚‚|å–:ã¨|é…’:ã•ã‘|å—:ã†|å·:ã—ã‚…ã†|æ‹¾:ã²ã‚|çµ‚:ãŠ|ç¿’:ãªã‚‰|é›†:ã‚ã¤|ä½:ã™|é‡:ãŠã‚‚|å®¿:ã‚„ã©|æ‰€:ã¨ã“ã‚|æš‘:ã‚ã¤|åŠ©:ãŸã™|æ˜­:ã—ã‚‡ã†|æ¶ˆ:ã‘|å•†:ã—ã‚‡ã†|ç« :ã—ã‚‡ã†|å‹:ã‹|ä¹—:ã®|æ¤:ã†|ç”³:ã‚‚ã†|èº«:ã¿|ç¥:ã‹ã¿|çœŸ:ã—ã‚“|æ·±:ãµã‹|é€²:ã™ã™|ä¸–:ã‚ˆ|æ•´:ã¨ã¨ã®|æ˜”:ã‚€ã‹ã—|å…¨:ãœã‚“|ç›¸:ã‚ã„|é€:ãŠã|æƒ³:ãã†|æ¯:ã„ã|é€Ÿ:ã¯ã‚„|æ—:ãã|ä»–:ã»ã‹|æ‰“:ã†|å¯¾:ãŸã„|å¾…:ã¾|ä»£:ã‹|ç¬¬:ã ã„|é¡Œ:ã ã„|ç‚­:ã™ã¿|çŸ­:ã¿ã˜ã‹|è«‡:ã ã‚“|ç€:ã|æ³¨:ã¡ã‚…ã†|æŸ±:ã¯ã—ã‚‰|ä¸:ã¡ã‚‡ã†|å¸³:ã¡ã‚‡ã†|èª¿:ã—ã‚‰|è¿½:ãŠ|å®š:ã¦ã„|åº­:ã«ã‚|ç¬›:ãµãˆ|é‰„:ã¦ã¤|è»¢:ã“ã‚|éƒ½:ã¿ã‚„ã“|åº¦:ã©|æŠ•:ãª|è±†:ã¾ã‚|å³¶:ã—ã¾|æ¹¯:ã‚†|ç™»:ã®ã¼|ç­‰:ã²ã¨|å‹•:ã†ã”|ç«¥:ã©ã†|è¾²:ã®ã†|æ³¢:ãªã¿|é…:ã¯ã„|å€:ã°ã„|ç®±:ã¯ã“|ç•‘:ã¯ãŸã‘|ç™º:ã¯ã¤|å:ã¯ã‚“|å‚:ã•ã‹|æ¿:ã„ãŸ|çš®:ã‹ã‚|æ‚²:ã‹ãª|ç¾:ã†ã¤ã|é¼»:ã¯ãª|ç­†:ãµã§|æ°·:ã“ãŠã‚Š|è¡¨:ãŠã‚‚ã¦|ç§’:ã³ã‚‡ã†|ç—…:ã‚„ã¾ã„|å“:ã—ãª|è² :ã¾|éƒ¨:ã¶|æœ:ãµã|ç¦:ãµã|ç‰©:ã‚‚ã®|å¹³:ãŸã„|è¿”:ã‹ãˆ|å‹‰:ã¹ã‚“|æ”¾:ã¯ãª|å‘³:ã‚ã˜|å‘½:ã„ã®ã¡|é¢:ã‚ã‚“|å•:ã‚‚ã‚“|å½¹:ã‚„ã|è–¬:ãã™ã‚Š|ç”±:ã‚†|æ²¹:ã‚ã¶ã‚‰|æœ‰:ã‚|éŠ:ã‚ã|äºˆ:ã‚ˆ|ç¾Š:ã²ã¤ã˜|æ´‹:ã‚ˆã†|è‘‰:ã¯|é™½:ã‚ˆã†|æ§˜:ã•ã¾|è½:ãŠ|æµ:ãªãŒ|æ—…:ãŸã³|ä¸¡:ã‚Šã‚‡ã†|ç·‘:ã¿ã©ã‚Š|ç¤¼:ã‚Œã„|åˆ—:ã‚Œã¤|ç·´:ã‚Œã‚“|è·¯:ã‚|å’Œ:ã‚
        4|æ„›:ã‚ã„|æ¡ˆ:ã‚ã‚“|ä»¥:ã„|è¡£:ã“ã‚ã‚‚|ä½:ãã‚‰ã„|å°:ã„ã‚“|è‹±:ãˆã„|æ „:ã•ã‹|å¡©:ã—ãŠ|å„„:ãŠã|åŠ :ãã‚|æœ:ã¯|è²¨:ã‹|èª²:ã‹|èŠ½:ã‚|æ”¹:ã‚ã‚‰ãŸ|æ¢°:ã‹ã„|å®³:ãŒã„|è¡—:ã¾ã¡|å„:ã‹ã|è¦š:ãŠã¼|å®Œ:ã‹ã‚“|å®˜:ã‹ã‚“|ç®¡:ãã |é–¢:ã‹ã‚“|è¦³:ã‹ã‚“|é¡˜:ã­ãŒ|å¸Œ:ã|å­£:ã|æ——:ã¯ãŸ|å™¨:ã†ã¤ã‚|æ©Ÿ:ã|è­°:ã|æ±‚:ã‚‚ã¨|æ³£:ãª|çµ¦:ãã‚…ã†|æŒ™:ã‚|æ¼:ãã‚‡|å…±:ã¨ã‚‚|å”:ãã‚‡ã†|é¡:ã‹ãŒã¿|ç«¶:ãã|æ¥µ:ãã‚|è¨“:ãã‚“|è»:ãã‚“|éƒ¡:ãã‚“|å¾„:ã‘ã„|æ™¯:ã‘ã„|èŠ¸:ã’ã„|æ¬ :ã‹|çµ:ã‚€ã™|å»º:ãŸ|å¥:ã™ã“|é¨“:ã‘ã‚“|å›º:ã‹ãŸ|åŠŸ:ã“ã†|å¥½:ã™|å€™:ã“ã†|åº·:ã“ã†|å·®:ã•|èœ:ãª|æœ€:ã•ã„|æ:ã–ã„|æ˜¨:ã•ã|æœ­:ãµã |åˆ·:ã™|å¯Ÿ:ã•ã¤|å‚:ã¾ã„|ç”£:ã†|æ•£:ã¡|æ®‹:ã®ã“|æ°:ã—|å¸:ã—|è©¦:ãŸã‚|å…:ã˜|æ²»:ãªãŠ|è¾:ã‚„|å¤±:ã—ã¤|å€Ÿ:ã‹|ç¨®:ãŸã­|å‘¨:ã¾ã‚|ç¥:ã„ã‚|é †:ã˜ã‚…ã‚“|åˆ:ã¯ã˜|æ¾:ã¾ã¤|ç¬‘:ã‚ã‚‰|å”±:ã¨ãª|ç„¼:ã‚„|ç…§:ã¦|è‡£:ã—ã‚“|ä¿¡:ã—ã‚“|æˆ:ãª|çœ:ã—ã‚‡ã†|æ¸…:ãã‚ˆ|é™:ã—ãš|å¸­:ã›ã|ç©:ã¤|æŠ˜:ãŠ|ç¯€:ãµã—|èª¬:ã¨|æµ…:ã‚ã•|æˆ¦:ãŸãŸã‹|é¸:ãˆã‚‰|ç„¶:ãœã‚“|äº‰:ã‚ã‚‰ã|å€‰:ãã‚‰|å·£:ã™|æŸ:ãŸã°|å´:ãŒã‚|ç¶š:ã¤ã¥|å’:ãã¤|å­«:ã¾ã”|å¸¯:ãŠã³|éšŠ:ãŸã„|é”:ãŸã¡|å˜:ãŸã‚“|ç½®:ãŠ|ä»²:ãªã‹|å…†:ã¡ã‚‡ã†|ä½:ã²ã|åº•:ãã“|çš„:ã¦ã|å…¸:ã¦ã‚“|ä¼:ã¤ãŸ|å¾’:ã¨|åŠª:ã¤ã¨|ç¯:ã²|åƒ:ã¯ãŸã‚‰|ç‰¹:ã¨ã|ç†±:ã‚ã¤|å¿µ:ã­ã‚“|æ•—:ã‚„ã¶|æ¢…:ã†ã‚|åš:ã¯ã|é£¯:ã‚ã—|é£›:ã¨|å¿…:ã‹ãªã‚‰|ç¥¨:ã²ã‚‡ã†|æ¨™:ã²ã‚‡ã†|ä¸:ãµ|å¤«:ãŠã£ã¨|ä»˜:ã¤|åºœ:ãµ|å‰¯:ãµã|å…µ:ã¸ã„|åˆ¥:ã‚ã‹|è¾º:ã¸ã‚“|å¤‰:ã‹|ä¾¿:ã¹ã‚“|åŒ…:ã¤ã¤|æ³•:ã»ã†|æœ›:ã®ã|ç‰§:ã¼ã|æœ«:ã™ãˆ|æº€:ã¾ã‚“|æœª:ã¿|æ°‘:ãŸã¿|ç„¡:ãª|ç´„:ã‚„ã|å‹‡:ã‚†ã†|è¦:ã„ã‚‹|é¤Š:ã‚„ã—ãª|æµ´:ã‚|åˆ©:ã‚Š|é™¸:ã‚Šã|è‰¯:ã‚ˆ|æ–™:ã‚Šã‚‡ã†|é‡:ã¯ã‹|è¼ª:ã‚|é¡:ã‚‹ã„|ä»¤:ã‚Œã„|å†·:ã¤ã‚|ä¾‹:ãŸã¨|é€£:ã¤ã‚‰|è€:ãŠ|åŠ´:ã‚ã†|éŒ²:ã‚ã|è³€:ãŒ|ç¾¤:ã‚€|å¾³:ã¨ã|å¯Œ:ã¨ã¿|åŸ:ã—ã‚|èŒ¨:ã„ã°ã‚‰|åª›:ã²ã‚|å²¡:ãŠã‹|æ½Ÿ:ã‹ãŸ|å²:ã|ç†Š:ãã¾|é¦™:ã‹ãŠã‚Š|ä½:ã•|åŸ¼:ã•ã„|å´:ã•ã|æ»‹:ã˜|é¹¿:ã—ã‹|ç¸„:ãªã‚|äº•:ã„|æ²–:ãŠã|æ ƒ:ã¨ã¡|å¥ˆ:ãª|æ¢¨:ãªã—|é˜ª:ã¯ã‚“|é˜œ:ãµ
        5|å›²:ã‹ã“|ç´€:ã|å–œ:ã‚ˆã‚ã“|æ•‘:ã™ã|å‹:ã‹ãŸ|èˆª:ã“ã†|å‘Š:ã¤|æ®º:ã•ã¤|å£«:ã—|å²:ã—|è±¡:ãã†|è³:ã—ã‚‡ã†|è²¯:ã¡ã‚‡|åœ:ã¦ã„|å ‚:ã©ã†|å¾—:ã¨ã|æ¯’:ã©ã|è²»:ã²|ç²‰:ã“ãª|è„ˆ:ã¿ã‚ƒã|æ­´:ã‚Œã|åœ§:ã‚ã¤|ç§»:ã†ã¤|å› :ã„ã‚“|æ°¸:ãªãŒ|å–¶:ã„ã¨ãª|è¡›:ãˆã„|æ˜“:ã‚„ã•|ç›Š:ãˆã|æ¶²:ãˆã|æ¼”:ãˆã‚“|å¿œ:ãŠã†|å¾€:ãŠã†|æ¡œ:ã•ãã‚‰|å¯:ã‹|ä»®:ã‹ã‚Š|ä¾¡:ã‹|æ²³:ã‹ã‚|é:ã™|è§£:ã¨|æ ¼:ã‹ã|ç¢º:ãŸã—|é¡:ãŒã|åˆŠ:ã‹ã‚“|å¹¹:ã¿ã|æ…£:ãª|çœ¼:ã‚|åŸº:ã‚‚ã¨|å¯„:ã‚ˆ|è¦:ã|æŠ€:ã‚ã–|ç¾©:ã|é€†:ãã‚ƒã|ä¹…:ã²ã•|æ—§:ãã‚…ã†|å±…:ã„|è¨±:ã‚†ã‚‹|å¢ƒ:ã•ã‹ã„|å‡:ãã‚“|ç¦:ãã‚“|å¥:ã|çµŒ:ã¸|æ½”:ã‘ã¤|ä»¶:ã‘ã‚“|é™º:ã‘ã‚|æ¤œ:ã‘ã‚“|é™:ã‹ã|ç¾:ã‚ã‚‰ã‚|æ¸›:ã¸|æ•…:ãµã‚‹|å€‹:ã“|è­·:ã¾ã‚‚|åŠ¹:ã“ã†|åš:ã‚ã¤|è€•:ãŸãŒã‚„|é‰±:ã“ã†|æ§‹:ã‹ã¾|èˆˆ:ãŠã“|è¬›:ã“ã†|æ··:ã¾|æŸ»:ã•|å†:ãµãŸãŸ|ç½:ã‚ã–ã‚|å¦»:ã¤ã¾|æ¡:ã¨|éš›:ã•ã„|åœ¨:ã‚|è²¡:ã–ã„|ç½ª:ã¤ã¿|é›‘:ã–ã¤|é…¸:ã•ã‚“|è³›:ã•ã‚“|æ”¯:ã•ã•|å¿—:ã“ã“ã‚ã–ã—|æ:ãˆã |å¸«:ã—|è³‡:ã—|é£¼:ã‹|ç¤º:ã—ã‚|ä¼¼:ã«|è­˜:ã—ã|è³ª:ã—ã¤|èˆ:ã—ã‚ƒ|è¬:ã‚ã‚„ã¾|æˆ:ã•ãš|ä¿®:ãŠã•|è¿°:ã®|è¡“:ã˜ã‚…ã¤|æº–:ã˜ã‚…ã‚“|åº:ã˜ã‚‡|æ‹›:ã¾ã­|è¨¼:ã—ã‚‡ã†|æ¡:ã˜ã‚‡ã†|çŠ¶:ã˜ã‚‡ã†|å¸¸:ã¤ã­|æƒ…:ãªã•|ç¹”:ãŠ|è·:ã—ã‚‡ã|åˆ¶:ã›ã„|æ€§:ã›ã„|æ”¿:ã¾ã¤ã‚Šã”ã¨|å‹¢:ã„ããŠ|ç²¾:ã›ã„|è£½:ã›ã„|ç¨:ãœã„|è²¬:ã›|ç¸¾:ã›ã|æ¥:ã¤|è¨­:ã‚‚ã†|çµ¶:ãŸ|ç¥–:ã|ç´ :ã|ç·:ãã†|é€ :ã¤ã|åƒ:ãã†|å¢—:ãµ|å‰‡:ãã|æ¸¬:ã¯ã‹|å±:ãã|ç‡:ã‚Šã¤|æ:ãã‚“|è²¸:ã‹|æ…‹:ãŸã„|å›£:ã ã‚“|æ–­:ã“ã¨ã‚|ç¯‰:ããš|å¼µ:ã¯|æ:ã¦ã„|ç¨‹:ã»ã©|é©:ã¦ã|çµ±:ã¨ã†|éŠ…:ã©ã†|å°:ã¿ã¡ã³|ç‹¬:ã²ã¨|ä»»:ã¾ã‹|ç‡ƒ:ã‚‚|èƒ½:ã®ã†|ç ´:ã‚„ã¶|çŠ¯:ãŠã‹|åˆ¤:ã¯ã‚“|ç‰ˆ:ã¯ã‚“|æ¯”:ãã‚‰|è‚¥:ã“|é:ã²|å‚™:ããª|è©•:ã²ã‚‡ã†|è²§:ã¾ãš|å¸ƒ:ã¬ã®|å©¦:ãµ|æ­¦:ã¶|å¾©:ãµã|è¤‡:ãµã|ä»:ã»ã¨ã‘|ç·¨:ã‚|å¼:ã¹ã‚“|ä¿:ãŸã‚‚|å¢“:ã¯ã‹|å ±:ã‚€ã|è±Š:ã‚†ãŸ|é˜²:ãµã›|è²¿:ã¼ã†|æš´:ã‚ã°|å‹™:ã¤ã¨|å¤¢:ã‚†ã‚|è¿·:ã¾ã‚ˆ|ç¶¿:ã‚ãŸ|è¼¸:ã‚†|ä½™:ã‚ã¾|å®¹:ã‚ˆã†|ç•¥:ã‚Šã‚ƒã|ç•™:ã¨|é ˜:ã‚Šã‚‡ã†|å¿«:ã‹ã„
        6|èƒƒ:ã„|è…¸:ã¡ã‚‡ã†|æ©:ãŠã‚“|åˆ¸:ã‘ã‚“|æ‰¿:ã—ã‚‡ã†|èˆŒ:ã—ãŸ|éŠ­:ãœã«|é€€:ã—ã‚Šã|æ•µ:ã¦ã|ä¿µ:ãŸã‚ã‚‰|é :ã‚ãš|ç•°:ã“ã¨|éº:ã„|åŸŸ:ã„ã|å®‡:ã†|æ˜ :ã†ã¤|å»¶:ã®|æ²¿:ã|æˆ‘:ã‚ã‚Œ|ç°:ã¯ã„|æ‹¡:ã‹ã|é©:ã‹ã‚|é–£:ã‹ã|å‰²:ã‚|æ ª:ã‹ã¶|å¹²:ã»|å·»:ã¾|çœ‹:ã‹ã‚“|ç°¡:ã‹ã‚“|å±:ã‚ã¶|æœº:ã¤ããˆ|è²´:ã¨ã†ã¨|ç–‘:ã†ãŸãŒ|å¸:ã™|ä¾›:ã¨ã‚‚|èƒ¸:ã‚€ã­|éƒ·:ãã‚‡ã†|å‹¤:ã¤ã¨|ç­‹:ã™ã˜|ç³»:ã‘ã„|æ•¬:ã†ã‚„ã¾|è­¦:ã‘ã„|åŠ‡:ã’ã|æ¿€:ã¯ã’|ç©´:ã‚ãª|çµ¹:ãã¬|æ¨©:ã‘ã‚“|æ†²:ã‘ã‚“|æº:ã¿ãªã‚‚ã¨|å³:ãã³|å·±:ãŠã®ã‚Œ|å‘¼:ã‚ˆ|èª¤:ã‚ã‚„ã¾|å:ã“ã†|å­:ã“ã†|çš‡:ã“ã†|ç´…:ã¹ã«|é™:ãŠ|é‹¼:ã¯ãŒã­|åˆ»:ãã–|ç©€:ã“ã|éª¨:ã»ã­|å›°:ã“ã¾|ç ‚:ã™ãª|åº§:ã™ã‚|æ¸ˆ:ã™|è£:ã•ã°|ç­–:ã•ã|å†Š:ã•ã¤|èš•:ã‹ã„ã“|è‡³:ã„ãŸ|ç§:ã‚ãŸã—|å§¿:ã™ãŒãŸ|è¦–:ã—|è©:ã—|èªŒ:ã—|ç£:ã˜|å°„:ã„|æ¨:ã™|å°º:ã—ã‚ƒã|è‹¥:ã‚ã‹|æ¨¹:ã|å:ãŠã•|å®—:ã—ã‚…ã†|å°±:ã¤|è¡†:ã—ã‚…ã†|å¾“:ã—ãŸãŒ|ç¸¦:ãŸã¦|ç¸®:ã¡ã¢|ç†Ÿ:ã†|ç´”:ã˜ã‚…ã‚“|å‡¦:ã—ã‚‡|ç½²:ã—ã‚‡|è«¸:ã‚‚ã‚|é™¤:ã®ã|å°†:ã—ã‚‡ã†|å‚·:ããš|éšœ:ã•ã‚|è’¸:ã‚€|é‡:ã¯ã‚Š|ä»:ã˜ã‚“|å‚:ãŸ|æ¨:ãŠ|å¯¸:ã™ã‚“|ç››:ã‚‚|è–:ã›ã„|èª :ã›ã„|å®£:ã›ã‚“|å°‚:ã‚‚ã£ã±|æ³‰:ã„ãšã¿|æ´—:ã‚ã‚‰|æŸ“:ã|å–„:ãœã‚“|å¥:ã‹ãª|çª“:ã¾ã©|å‰µ:ã¤ã|è£…:ã‚ˆããŠ|å±¤:ãã†|æ“:ã‚ã‚„ã¤|è”µ:ãã‚‰|è‡“:ãã†|å­˜:ãã‚“|å°Š:ã¨ã†ã¨|å®…:ãŸã|æ‹…:ã«ãª|æ¢:ã•ãŒ|èª•:ãŸã‚“|æ®µ:ã ã‚“|æš–:ã‚ãŸãŸ|å€¤:ã­|å®™:ã¡ã‚…ã†|å¿ :ã¡ã‚…ã†|è‘—:ã‚ã‚‰ã‚|åº:ã¡ã‚‡ã†|é ‚:ã„ãŸã ã|æ½®:ã—ãŠ|è³ƒ:ã¡ã‚“|ç—›:ã„ãŸ|å±•:ã¦ã‚“|è¨:ã†|å…š:ã¨ã†|ç³–:ã¨ã†|å±Š:ã¨ã©|é›£:ã‚€ãšã‹|ä¹³:ã¡ã¡|èª:ã¿ã¨|ç´:ãŠã•|è„³:ã®ã†|æ´¾:ã¯|æ‹:ãŠãŒ|èƒŒ:ã›|è‚º:ã¯ã„|ä¿³:ã¯ã„|ç­:ã¯ã‚“|æ™©:ã°ã‚“|å¦:ã„ãª|æ‰¹:ã²|ç§˜:ã²|è…¹:ã¯ã‚‰|å¥®:ãµã‚‹|ä¸¦:ãªã‚‰|é™›:ã¸ã„|é–‰:ã—|ç‰‡:ã‹ãŸ|è£œ:ãŠããª|æš®:ã|å®:ãŸã‹ã‚‰|è¨ª:ãŠã¨ãš|äº¡:ãª|å¿˜:ã‚ã™|æ£’:ã¼ã†|æš:ã¾ã„|å¹•:ã¾ã|å¯†:ã¿ã¤|ç›Ÿ:ã‚ã„|æ¨¡:ã‚‚|è¨³:ã‚ã‘|éƒµ:ã‚†ã†|å„ª:ã‚„ã•|å¹¼:ãŠã•ãª|æ¬²:ã»|ç¿Œ:ã‚ˆã|ä¹±:ã¿ã |åµ:ãŸã¾ã”|è¦§:ã‚‰ã‚“|è£:ã†ã‚‰|å¾‹:ã‚Šã¤|è‡¨:ã®ã|æœ—:ã‚ã†|è«–:ã‚ã‚“|æ®:ã
        `;

        const searchDB = [];
        const gradeColors = { 1:"#FF8A65", 2:"#FFD54F", 3:"#4FC3F7", 4:"#81C784", 5:"#BA68C8", 6:"#7986CB" };

        rawData.trim().split('\n').forEach(line => {
            line = line.trim();
            if(!line) return;
            const parts = line.split('|');
            const grade = parseInt(parts[0]);
            
            for(let i=1; i<parts.length; i++) {
                const entry = parts[i].split(':');
                searchDB.push({
                    char: entry[0],
                    reading: entry[1] || "",
                    grade: grade
                });
            }
        });

        // =========================================
        // 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ (App & Portal)
        // =========================================
        
        let currentGrade = 0;
        let currentAppKanjiData = [];
        let writer;
        let currentChar = null;
        let currentMode = 'practice';
        
        // --- èµ·å‹•ãƒ»åˆæœŸåŒ– ---
        function launchApp(grade) {
            currentGrade = grade;
            currentAppKanjiData = searchDB.filter(item => item.grade === grade);
            
            document.getElementById('portal-view').style.display = 'none';
            document.getElementById('app-view').style.display = 'block';
            document.body.classList.add('app-mode');

            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            const titleEl = document.querySelector('#title-screen-app .game-title');
            titleEl.innerHTML = `${grade}ã­ã‚“ã›ã„<br>ã‹ã‚“ã˜ãƒã‚¹ã‚¿ãƒ¼`;

            showAppScreen('title-screen-app');
        }

        function exitApp() {
            document.getElementById('app-view').style.display = 'none';
            document.getElementById('portal-view').style.display = 'block';
            document.body.classList.remove('app-mode');
            updatePortalUI(); // ãƒãƒ¼ã‚¿ãƒ«ã®è¡¨ç¤ºã‚’æœ€æ–°ã«æ›´æ–°
        }

        function showAppScreen(id) {
            document.querySelectorAll('#app-view .screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'list-screen') {
                document.getElementById('app-search-box').value = '';
                renderAppList(currentAppKanjiData);
            }
        }

        function selectMode(mode) {
            playSound('click');
            currentMode = mode;
            showAppScreen('list-screen');
        }

        // --- ãƒªã‚¹ãƒˆè¡¨ç¤º ---
        function filterAppList() {
            const query = document.getElementById('app-search-box').value.trim();
            if(!query) { renderAppList(currentAppKanjiData); return; }
            const filtered = currentAppKanjiData.filter(i => i.char.includes(query) || i.reading.includes(query));
            renderAppList(filtered);
        }

        function renderAppList(data) {
            const grid = document.getElementById('kanji-grid');
            grid.innerHTML = '';
            
            const badge = document.getElementById('mode-display');
            const pPractice = JSON.parse(localStorage.getItem(`kanjiMasterPractice_${currentGrade}`)) || {};
            const pTest = JSON.parse(localStorage.getItem(`kanjiMasterTest_${currentGrade}`)) || {};
            
            const targetP = (currentMode==='practice') ? pPractice : pTest;
            let clearedCount = 0;
            currentAppKanjiData.forEach(k => { if(targetP[k.char]) clearedCount++; });

            document.getElementById('star-counter').textContent = clearedCount;
            document.getElementById('max-count').textContent = currentAppKanjiData.length;

            if (currentMode === 'practice') {
                badge.textContent = "â­ ã‚Œã‚“ã—ã‚…ã†ãƒ¢ãƒ¼ãƒ‰";
                badge.style.backgroundColor = "#4CAF50";
            } else {
                badge.textContent = "ğŸ‘‘ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰";
                badge.style.backgroundColor = "#F44336";
            }

            if(data.length === 0) { grid.innerHTML = '<div style="color:#888; grid-column:1/-1; text-align:center;">ã¿ã¤ã‹ã‚Šã¾ã›ã‚“</div>'; return; }

            data.forEach(item => {
                const isCleared = targetP[item.char];
                const div = document.createElement('div');
                div.className = 'kanji-card';
                if(isCleared) div.classList.add(currentMode==='practice'?'cleared-practice':'cleared-test');
                
                div.innerHTML = `${item.char}<div class="mark star-mark">â­</div><div class="mark crown-mark">ğŸ‘‘</div>`;
                div.onclick = () => { playSound('click'); startWriting(item); };
                grid.appendChild(div);
            });
        }

        // --- æ›¸ãå–ã‚Šãƒ­ã‚¸ãƒƒã‚¯ ---
        function startWriting(item) {
            currentChar = item;
            showAppScreen('practice-screen');
            document.getElementById('result-overlay').classList.remove('active');
            
            const isTest = (currentMode === 'test');
            const screen = document.getElementById('practice-screen');
            const msg = document.getElementById('message-area');
            const reading = document.getElementById('current-reading');

            if(isTest) {
                screen.classList.add('test-bg');
                msg.innerText = "ã“ã® ã‹ã‚“ã˜ ã‚’ ã‹ã“ã†ï¼";
                msg.style.color = "#C62828";
                reading.innerText = item.reading;
            } else {
                screen.classList.remove('test-bg');
                msg.innerText = "ã†ã™ã„ã›ã‚“ã‚’ ãªãã‚ã†ï¼";
                msg.style.color = "#006064";
                reading.innerText = `${item.char} (${item.reading})`;
            }

            document.getElementById('character-target-div').innerHTML = '';
            
            writer = HanziWriter.create('character-target-div', item.char, {
                width: 300, height: 300, padding: 10,
                showOutline: !isTest, strokeAnimationSpeed: 1, delayBetweenStrokes: 200,
                radicalColor: '#168F16', drawingWidth: 25, outlineColor: '#DDD',
                strokeColor: '#333', highlightColor: '#FF7043', showHintAfterMisses: 1,
                charDataLoader: (char, onComplete) => {
                    fetch(`https://cdn.jsdelivr.net/gh/chanind/hanzi-writer-data-jp@master/data/${char}.json`)
                    .then(r => r.json()).then(onComplete)
                    .catch(() => {
                        fetch(`https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${char}.json`)
                        .then(r => r.json()).then(onComplete);
                    });
                }
            });
            writer.quiz({
                onMistake: () => { playSound('error'); msg.innerText = isTest ? "ãŠã—ã„ï¼" : "ã“ã“ã ã‚ˆï¼"; msg.style.color="#D32F2F"; },
                onCorrectStroke: () => { playSound('success'); msg.innerText = "ã„ã„ã­ï¼"; msg.style.color="#388E3C"; },
                onComplete: handleComplete
            });
        }

        function handleComplete() {
            // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã‚’ä¿å­˜ï¼ˆæ¯”è¼ƒç”¨ï¼‰
            const oldStats = getAllStats();
            const oldLevel = Math.floor(oldStats.totalStars / STARS_PER_LEVEL);

            const key = (currentMode==='practice') ? `kanjiMasterPractice_${currentGrade}` : `kanjiMasterTest_${currentGrade}`;
            const data = JSON.parse(localStorage.getItem(key)) || {};
            
            // åˆã‚¯ãƒªã‚¢ã‹ã©ã†ã‹åˆ¤å®š
            const isFirstClear = !data[currentChar.char];
            data[currentChar.char] = true;
            localStorage.setItem(key, JSON.stringify(data));

            const msg = document.getElementById('message-area');
            const title = document.getElementById('result-title-text');
            
            if(currentMode === 'practice') {
                msg.innerText = "ã§ããŸãƒ¼ï¼ â­ã‚²ãƒƒãƒˆï¼";
                title.innerText = "ã§ããŸãƒ¼ï¼â­";
                title.style.color = "#4CAF50";
            } else {
                msg.innerText = "ã™ã”ã„ï¼ï¼ ğŸ‘‘ã‚²ãƒƒãƒˆï¼";
                title.innerText = "ã™ã”ã„ï¼ğŸ‘‘";
                title.style.color = "#F44336";
            }

            // æ–°ã—ã„ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—ã—ã¦ã€ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—åˆ¤å®š
            const newStats = getAllStats();
            const newLevel = Math.floor(newStats.totalStars / STARS_PER_LEVEL);

            setTimeout(() => {
                if (isFirstClear && newLevel > oldLevel) {
                    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡º
                    showLevelUpInApp(newLevel);
                } else {
                    playSound('complete');
                    document.getElementById('result-overlay').classList.add('active');
                }
            }, 800);
        }

        function showLevelUpInApp(lv) {
            playSound('levelup');
            const popup = document.getElementById('levelup-popup');
            const settings = getPortalSettings();
            const chars = COURSES[settings.currentCourse].chars;
            const char = chars[Math.min(lv, chars.length-1)];
            
            document.getElementById('levelup-emoji').textContent = char;
            document.getElementById('levelup-char').textContent = `Lv.${lv} ã«ãªã£ãŸã‚ˆï¼`;
            
            popup.classList.add('show');
            setTimeout(() => {
                popup.classList.remove('show');
                document.getElementById('result-overlay').classList.add('active');
            }, 3000);
        }

        function goNext() {
            const idx = currentAppKanjiData.findIndex(k => k.char === currentChar.char);
            if(idx >= 0 && idx < currentAppKanjiData.length - 1) startWriting(currentAppKanjiData[idx+1]);
            else { alert("ã“ã‚Œã§ãŠã—ã¾ã„ï¼"); showAppScreen('list-screen'); }
        }
        function retry() { startWriting(currentChar); }

        // --- éŸ³å£° ---
        let audioCtx;
        function playSound(type) {
            if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            const t = audioCtx.currentTime;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            
            if(type==='success') {
                o.frequency.setValueAtTime(800, t); o.frequency.exponentialRampToValueAtTime(1200, t+0.1);
                g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
                o.start(t); o.stop(t+0.1);
            } else if(type==='complete') {
                o.frequency.setValueAtTime(500, t); o.frequency.linearRampToValueAtTime(800, t+0.1);
                g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.3);
                o.start(t); o.stop(t+0.3);
            } else if(type==='click') {
                o.frequency.setValueAtTime(600, t); o.frequency.exponentialRampToValueAtTime(300, t+0.05);
                g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.05);
                o.start(t); o.stop(t+0.05);
            } else if(type==='error') {
                o.type = 'sawtooth';
                o.frequency.setValueAtTime(150, t); o.frequency.linearRampToValueAtTime(100, t+0.2);
                g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.2);
                o.start(t); o.stop(t+0.2);
            } else if(type==='levelup') {
                // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
                [523, 659, 784, 1046].forEach((f, i) => {
                    const os = audioCtx.createOscillator();
                    const gn = audioCtx.createGain();
                    os.connect(gn); gn.connect(audioCtx.destination);
                    os.frequency.value = f;
                    gn.gain.setValueAtTime(0.2, t + i*0.1);
                    gn.gain.exponentialRampToValueAtTime(0.01, t + i*0.1 + 0.4);
                    os.start(t + i*0.1); os.stop(t + i*0.1 + 0.4);
                });
            }
        }

        // --- æ¤œç´¢ (ãƒãƒ¼ã‚¿ãƒ«) ---
        const sInput = document.getElementById('search-input');
        const sRes = document.getElementById('search-results');
        sInput.addEventListener('input', (e) => {
            const v = e.target.value.trim();
            sRes.innerHTML = '';
            if(!v) { sRes.style.display='none'; return; }
            
            const hits = searchDB.filter(i => i.char.includes(v) || i.reading.includes(v)).slice(0,10);
            if(hits.length) {
                hits.forEach(m => {
                    const d = document.createElement('div');
                    d.className = 'result-card';
                    d.innerHTML = `<div><span style="font-size:1.5rem; color:${gradeColors[m.grade]}">${m.char}</span> <span style="font-size:0.8rem; color:#666;">${m.grade}å¹´</span></div><span style="background:${gradeColors[m.grade]}; color:white; padding:4px 10px; border-radius:10px; font-size:0.8rem;">Go</span>`;
                    d.onclick = () => { sRes.style.display='none'; sInput.value=''; launchApp(m.grade); };
                    sRes.appendChild(d);
                });
                sRes.style.display = 'block';
            } else {
                sRes.innerHTML = '<div style="padding:10px; text-align:center;">ãªã—</div>';
                sRes.style.display = 'block';
            }
        });
        document.body.addEventListener('click', (e) => { if(!e.target.closest('.search-container')) sRes.style.display='none'; });

        // åˆæœŸåŒ–
        updatePortalUI();
  </script>
 </body>
</html>
